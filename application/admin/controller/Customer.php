<?php
/*
 本代码由 成都大猿人网络科技有限公司 原创开发
 官方网址：www.dayuanren.cn
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace app\admin\controller;use app\common\library\AgentGrade;use app\common\library\Createlog;use app\common\model\Balance;use app\common\model\Client;use app\common\model\CustomerHezuoPrice;use app\common\model\Product as ProductModel;use Util\GoogleAuth;use Util\Random;class Customer extends Admin{public function _init(){$Kh9MC=!IS_CLI;$Kh9MG=(bool)$Kh9MC;if($Kh9MG)goto Kh9eWjgx5;goto Kh9ldMhx5;Kh9eWjgx5:$Kh9MD=!function_exists('get_shoquan_key');$Kh9MF=(bool)$Kh9MD;$Kh9MH=!$Kh9MF;if($Kh9MH)goto Kh9eWjgx3;goto Kh9ldMhx3;Kh9eWjgx3:$Kh9ME=!S(md5(get_shoquan_key()));$Kh9MF=$Kh9MD||$Kh9ME;goto Kh9x2;Kh9ldMhx3:Kh9x2:$Kh9MG=$Kh9MC&&$Kh9MF;goto Kh9x4;Kh9ldMhx5:Kh9x4:if($Kh9MG)goto Kh9eWjgx6;goto Kh9ldMhx6;Kh9eWjgx6:echo C('sqyc_msg');exit();goto Kh9x1;Kh9ldMhx6:Kh9x1:}public function index(){unset($Kh9tIMC);$Kh9tIMC=$this->create_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$this->getList($map);$list=$Kh9tIMC;$this->assign('_list',$list);$this->assign('_count',$list->total());return view();}private function create_map(){unset($Kh9tIMC);$Kh9tIMC=0;$map['c.is_del']=$Kh9tIMC;if(I('key'))goto Kh9eWjgx8;goto Kh9ldMhx8;Kh9eWjgx8:if(I('query_name'))goto Kh9eWjgxa;goto Kh9ldMhxa;Kh9eWjgxa:unset($Kh9tIMC);$Kh9tIMC=trim(I('key'));$map[I('query_name')]=$Kh9tIMC;goto Kh9x9;Kh9ldMhxa:$Kh9vPMC='%' . trim(I('key'));$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['c.username|c.mobile']=$Kh9tIME;Kh9x9:goto Kh9x7;Kh9ldMhx8:Kh9x7:if(I('grade_id'))goto Kh9eWjgxc;goto Kh9ldMhxc;Kh9eWjgxc:unset($Kh9tIMC);$Kh9tIMC=I('grade_id');$map['c.grade_id']=$Kh9tIMC;goto Kh9xb;Kh9ldMhxc:Kh9xb:if(I('is_subscribe'))goto Kh9eWjgxe;goto Kh9ldMhxe;Kh9eWjgxe:$Kh9MC=intval(I('is_subscribe'))-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$map['c.is_subscribe']=$Kh9tIMD;goto Kh9xd;Kh9ldMhxe:Kh9xd:if(I('status'))goto Kh9eWjgxg;goto Kh9ldMhxg;Kh9eWjgxg:$Kh9MC=I('status')-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$map['c.status']=$Kh9tIMD;goto Kh9xf;Kh9ldMhxg:Kh9xf:if(I('id'))goto Kh9eWjgxi;goto Kh9ldMhxi;Kh9eWjgxi:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['c.id']=$Kh9tIMC;goto Kh9xh;Kh9ldMhxi:Kh9xh:if(I('f_id'))goto Kh9eWjgxk;goto Kh9ldMhxk;Kh9eWjgxk:unset($Kh9tIMC);$Kh9tIMC=I('f_id');$map['c.f_id']=$Kh9tIMC;goto Kh9xj;Kh9ldMhxk:Kh9xj:if(I('client'))goto Kh9eWjgxm;goto Kh9ldMhxm;Kh9eWjgxm:unset($Kh9tIMC);$Kh9tIMC=I('client');$map['c.client']=$Kh9tIMC;goto Kh9xl;Kh9ldMhxm:Kh9xl:if(I('type'))goto Kh9eWjgxo;goto Kh9ldMhxo;Kh9eWjgxo:unset($Kh9tIMC);$Kh9tIMC=I('type');$map['c.type']=$Kh9tIMC;$this->assign("grades",M('customer_grade')->where(array('grade_type'=>I('type')))->order("sort asc,grade_type asc")->select());goto Kh9xn;Kh9ldMhxo:$this->assign("grades",array());Kh9xn:return $map;}private function getList($map,$page=true){if(I('sort'))goto Kh9eWjgxq;goto Kh9ldMhxq;Kh9eWjgxq:unset($Kh9tIMC);$Kh9tIMC=I('sort');$sort=$Kh9tIMC;goto Kh9xp;Kh9ldMhxq:unset($Kh9tIMC);$Kh9tIMC="id desc";$sort=$Kh9tIMC;Kh9xp:if($page)goto Kh9eWjgxs;goto Kh9ldMhxs;Kh9eWjgxs:unset($Kh9tIMC);$Kh9tIMC=M('Customer c')->where($map)->field('c.*,(select username from dyr_customer where id=c.f_id) as usernames,(select grade_name from dyr_customer_grade where id=c.grade_id) as grade_name,(select is_zdy_price from dyr_customer_grade where id=c.grade_id) as is_zdy_price,(select sum(total_price) from dyr_porder where customer_id=c.id and status in (2,3,4)) as total_price,(select count(*) from dyr_porder where customer_id=c.id and status not in (1,7)) as porder_num,(select count(*) from dyr_porder where customer_id=c.id and status not in (1,7) and create_time >= UNIX_TIMESTAMP(curdate())) as porder_jinnum,(select count(*) from dyr_porder where customer_id=c.id and status in (4,12,13) and finish_time >= UNIX_TIMESTAMP(curdate())) as porder_jincgnum,(select is_zdy_price from dyr_customer_grade where id=c.grade_id) as is_zdy_price,(select sum(total_price) from dyr_porder where customer_id=c.id and status not in (1,7) and create_time >= UNIX_TIMESTAMP(curdate())) as total_jinprice,(select sum(total_price - refund_price) from dyr_porder where customer_id=c.id and status in (4,12,13) and finish_time >= UNIX_TIMESTAMP(curdate())) as total_jincgprice,(select sum(total_price) from dyr_porder where customer_id=c.id and status in (2,3,8,9,10,11)) as total_czprice,(select count(*) from dyr_customer where f_id=c.id and is_del=0) as child_num')->order($sort)->paginate(C('LIST_ROWS'));$list=$Kh9tIMC;goto Kh9xr;Kh9ldMhxs:unset($Kh9tIMC);$Kh9tIMC=M('Customer c')->where($map)->field('c.*,(select username from dyr_customer where id=c.f_id) as usernames,(select grade_name from dyr_customer_grade where id=c.grade_id) as grade_name,(select is_zdy_price from dyr_customer_grade where id=c.grade_id) as is_zdy_price,(select sum(total_price) from dyr_porder where customer_id=c.id and status in (2,3,4)) as total_price,(select count(*) from dyr_porder where customer_id=c.id and status not in (1,7)) as porder_num,(select count(*) from dyr_customer where f_id=c.id and is_del=0) as child_num')->order($sort)->select();$list=$Kh9tIMC;Kh9xr:return $list;}public function customer_excel(){unset($Kh9tIMC);$Kh9tIMC=$this->create_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$this->getList($map,false);$ret=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array(array('title'=>'昵称','field'=>'username'),array('title'=>'手机','field'=>'mobile'),array('title'=>'注册时间','field'=>'create_time'),array('title'=>'会员类型','field'=>'type'),array('title'=>'等级','field'=>'grade_name'),array('title'=>'appid','field'=>'weixin_appid'),array('title'=>'openid','field'=>'wx_openid'),array('title'=>'余额','field'=>'balance'),array('title'=>'订单金额','field'=>'total_price'),array('title'=>'订单数','field'=>'porder_num'));$field_arr=$Kh9tIMC;foreach($ret as $key=>$vo){unset($Kh9tIMC);$Kh9tIMC=C('CUS_TYPE')[$vo['type']];$ret[$key]['type']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['create_time']);$ret[$key]['create_time']=$Kh9tIMC;}$Kh9vPMC='会员列表' . time();$this->exportToExcel($Kh9vPMC,$field_arr,$ret);}public function edit(){if(request()->isPost())goto Kh9eWjgxu;goto Kh9ldMhxu;Kh9eWjgxu:unset($Kh9tIMC);$Kh9tIMC=I('post.');$arr=$Kh9tIMC;if(I('id'))goto Kh9eWjgxw;goto Kh9ldMhxw;Kh9eWjgxw:unset($Kh9tIMC);$Kh9tIMC=M('Customer')->where(array('id'=>I('id')))->setField($arr);$data=$Kh9tIMC;if($data)goto Kh9eWjgxy;goto Kh9ldMhxy;Kh9eWjgxy:$Kh9vPMC='修改信息：' . json_encode($arr);$Kh9vPMD='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),$Kh9vPMC,$Kh9vPMD);return $this->success('保存成功');goto Kh9xx;Kh9ldMhxy:return $this->error('编辑失败');Kh9xx:goto Kh9xv;Kh9ldMhxw:unset($Kh9tIMC);$Kh9tIMC=I('username');$username=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('mobile');$mobile=$Kh9tIMC;$Kh9MC=$username=='';$Kh9ME=(bool)$Kh9MC;$Kh9MF=!$Kh9ME;if($Kh9MF)goto Kh9eWjgx12;goto Kh9ldMhx12;Kh9eWjgx12:$Kh9MD=$mobile=='';$Kh9ME=$Kh9MC||$Kh9MD;goto Kh9x11;Kh9ldMhx12:Kh9x11:if($Kh9ME)goto Kh9eWjgx13;goto Kh9ldMhx13;Kh9eWjgx13:return $this->error('用户名和联系方式必须');goto Kh9xz;Kh9ldMhx13:Kh9xz:if(M('Customer')->where(array('username'=>I('username')))->find())goto Kh9eWjgx15;goto Kh9ldMhx15;Kh9eWjgx15:return $this->error('已有相同用户名的用户');goto Kh9x14;Kh9ldMhx15:Kh9x14:unset($Kh9tIMC);$Kh9tIMC=dyr_encrypt(I('password'));$arr['password']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=2;$arr['type']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=Client::CLIENT_ADM;$arr['client']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time();$arr['create_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=Random::alnum(32);$arr['apikey']=$Kh9tIMC;if($arr['headimg'])goto Kh9eWjgx17;goto Kh9ldMhx17;Kh9eWjgx17:$Kh9MC=$arr['headimg'];goto Kh9x16;Kh9ldMhx17:$Kh9MC=C('DEFAULT_HEADIMG');Kh9x16:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['headimg']=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=M('Customer')->insertGetId($arr);$inid=$Kh9tIMC;if($inid)goto Kh9eWjgx19;goto Kh9ldMhx19;Kh9eWjgx19:Createlog::customerLog($inid,'后台注册成功',$this->adminuser['nickname']);return $this->success('新增成功');goto Kh9x18;Kh9ldMhx19:return $this->error('新增失败');Kh9x18:Kh9xv:goto Kh9xt;Kh9ldMhxu:$this->assign("grades",M('customer_grade')->select());unset($Kh9tIMC);$Kh9tIMC=M('Customer')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);return view();Kh9xt:}public function edita(){unset($Kh9tIMC);$Kh9tIMC=M('Customer')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);return view();}public function get_grades(){unset($Kh9tIMC);$Kh9tIMC=array();$map=$Kh9tIMC;if(I('grade_type'))goto Kh9eWjgx1b;goto Kh9ldMhx1b;Kh9eWjgx1b:unset($Kh9tIMC);$Kh9tIMC=I('grade_type');$map['grade_type']=$Kh9tIMC;goto Kh9x1a;Kh9ldMhx1b:Kh9x1a:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->where($map)->order("sort asc,grade_type asc")->select();$grades=$Kh9tIMC;return djson(0,'ok',$grades);}public function deletes(){if(M('Customer')->where(array('id'=>I('id')))->setField(array('is_del'=>1)))goto Kh9eWjgx1d;goto Kh9ldMhx1d;Kh9eWjgx1d:$Kh9vPMC='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),'删除账户',$Kh9vPMC);return $this->success('删除成功');goto Kh9x1c;Kh9ldMhx1d:return $this->error('删除失败');Kh9x1c:}public function del_poster(){unset($Kh9tIMC);$Kh9tIMC=0;$map['is_del']=$Kh9tIMC;if(I('id'))goto Kh9eWjgx1f;goto Kh9ldMhx1f;Kh9eWjgx1f:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['id']=$Kh9tIMC;goto Kh9x1e;Kh9ldMhx1f:Kh9x1e:M('Customer')->where($map)->setField(array('qr_value'=>'','qrurl'=>'','share_img_time'=>'0','mp_qrurl'=>'','h5_qrurl'=>''));return $this->success('清空成功');}public function qi_jin(){$Kh9MC=I('status')==0;if($Kh9MC)goto Kh9eWjgx1h;goto Kh9ldMhx1h;Kh9eWjgx1h:if(M('Customer')->where(array('id'=>I('id')))->setField(array('status'=>0)))goto Kh9eWjgx1j;goto Kh9ldMhx1j;Kh9eWjgx1j:$Kh9vPMC='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),'禁用账户',$Kh9vPMC);return $this->success('禁用成功');goto Kh9x1i;Kh9ldMhx1j:return $this->error('禁用失败');Kh9x1i:goto Kh9x1g;Kh9ldMhx1h:if(M('Customer')->where(array('id'=>I('id')))->setField(array('status'=>1)))goto Kh9eWjgx1l;goto Kh9ldMhx1l;Kh9eWjgx1l:$Kh9vPMC='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),'启用账户',$Kh9vPMC);return $this->success('启用成功');goto Kh9x1k;Kh9ldMhx1l:return $this->error('启用失败');Kh9x1k:Kh9x1g:}public function balance_log(){unset($Kh9tIMC);$Kh9tIMC=0;$vava=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$this->balance_create_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log b')->join('customer c','c.id=b.customer_id')->where($map)->field('b.*,c.username,c.headimg')->order("b.id desc")->paginate(50)->each(function($item,$key)use(&$vava,$map){$Kh9ME=(bool)isset($map['b.customer_id']);if($Kh9ME)goto Kh9eWjgx1q;goto Kh9ldMhx1q;Kh9eWjgx1q:$Kh9MC=(bool)isset($map['b.style']);$Kh9MF=!$Kh9MC;if($Kh9MF)goto Kh9eWjgx1o;goto Kh9ldMhx1o;Kh9eWjgx1o:$Kh9MC=isset($map['b.style'])||isset($map['b.remark']);goto Kh9x1n;Kh9ldMhx1o:Kh9x1n:$Kh9MD=!$Kh9MC;$Kh9ME=isset($map['b.customer_id'])&&$Kh9MD;goto Kh9x1p;Kh9ldMhx1q:Kh9x1p:if($Kh9ME)goto Kh9eWjgx1r;goto Kh9ldMhx1r;Kh9eWjgx1r:$Kh9MC=round(floatval($vava),2)==round(floatval($item['balance']),2);$Kh9ME=(bool)$Kh9MC;$Kh9MH=!$Kh9ME;if($Kh9MH)goto Kh9eWjgx1v;goto Kh9ldMhx1v;Kh9eWjgx1v:$Kh9MD=$key==0;$Kh9ME=$Kh9MC||$Kh9MD;goto Kh9x1u;Kh9ldMhx1v:Kh9x1u:if($Kh9ME)goto Kh9eWjgx1t;goto Kh9ldMhx1t;Kh9eWjgx1t:$Kh9MF=1;goto Kh9x1s;Kh9ldMhx1t:$Kh9MF=0;Kh9x1s:unset($Kh9tIMG);$Kh9tIMG=$Kh9MF;$item['check']=$Kh9tIMG;goto Kh9x1m;Kh9ldMhx1r:unset($Kh9tIMC);$Kh9tIMC=2;$item['check']=$Kh9tIMC;Kh9x1m:$Kh9MC=$item['type']==1;if($Kh9MC)goto Kh9eWjgx1x;goto Kh9ldMhx1x;Kh9eWjgx1x:$Kh9MD=-1*$item['money'];$Kh9ME=$Kh9MD;goto Kh9x1w;Kh9ldMhx1x:$Kh9MF=+1*$item['money'];$Kh9ME=$Kh9MF;Kh9x1w:$Kh9MG=$item['balance']+$Kh9ME;unset($Kh9tIMH);$Kh9tIMH=$Kh9MG;$vava=$Kh9tIMH;return $item;});$list=$Kh9tIMC;$this->assign('_list',$list);return view();}private function balance_create_map(){unset($Kh9tIMC);$Kh9tIMC=array();$map=$Kh9tIMC;if(I('style'))goto Kh9eWjgx2z;goto Kh9ldMhx2z;Kh9eWjgx2z:unset($Kh9tIMC);$Kh9tIMC=I('style');$map['b.style']=$Kh9tIMC;goto Kh9x1y;Kh9ldMhx2z:Kh9x1y:if(I('id'))goto Kh9eWjgx22;goto Kh9ldMhx22;Kh9eWjgx22:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['b.customer_id']=$Kh9tIMC;goto Kh9x21;Kh9ldMhx22:Kh9x21:if(I('key'))goto Kh9eWjgx24;goto Kh9ldMhx24;Kh9eWjgx24:$Kh9vPMC='%' . I('key');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['b.remark']=$Kh9tIME;goto Kh9x23;Kh9ldMhx24:Kh9x23:$Kh9MC=(bool)I('end_time');if($Kh9MC)goto Kh9eWjgx27;goto Kh9ldMhx27;Kh9eWjgx27:$Kh9MC=I('end_time')&&I('begin_time');goto Kh9x26;Kh9ldMhx27:Kh9x26:if($Kh9MC)goto Kh9eWjgx28;goto Kh9ldMhx28;Kh9eWjgx28:unset($Kh9tIMC);$Kh9tIMC=array('between',array(strtotime(I('begin_time')),strtotime(I('end_time'))));$map['b.create_time']=$Kh9tIMC;goto Kh9x25;Kh9ldMhx28:Kh9x25:$Kh9MC=I('operator')!='';if($Kh9MC)goto Kh9eWjgx2a;goto Kh9ldMhx2a;Kh9eWjgx2a:$Kh9vPMC='%' . I('operator');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['operator']=$Kh9tIME;goto Kh9x29;Kh9ldMhx2a:Kh9x29:return $map;}public function balance_out_excel(){unset($Kh9tIMC);$Kh9tIMC=$this->balance_create_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log b')->join('customer c','c.id=b.customer_id')->where($map)->field('b.*,c.username,c.headimg')->order("b.id desc")->select();$ret=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array(array('title'=>'账号','field'=>'username'),array('title'=>'账号ID','field'=>'customer_id'),array('title'=>'交易时间','field'=>'create_time'),array('title'=>'交易方式','field'=>'type'),array('title'=>'交易金额','field'=>'money'),array('title'=>'交易明细','field'=>'remark'),array('title'=>'交易类型','field'=>'style'),array('title'=>'余额','field'=>'balance'));$field_arr=$Kh9tIMC;foreach($ret as $key=>$vo){$Kh9MC=$vo['type']==1;if($Kh9MC)goto Kh9eWjgx2c;goto Kh9ldMhx2c;Kh9eWjgx2c:$Kh9MD='收入';goto Kh9x2b;Kh9ldMhx2c:$Kh9MD='支出';Kh9x2b:unset($Kh9tIME);$Kh9tIME=$Kh9MD;$ret[$key]['type']=$Kh9tIME;$Kh9MC=$vo['type']==1;if($Kh9MC)goto Kh9eWjgx2e;goto Kh9ldMhx2e;Kh9eWjgx2e:$Kh9MD=$vo['money'];goto Kh9x2d;Kh9ldMhx2e:$Kh9ME=-1*$vo['money'];$Kh9MD=$Kh9ME;Kh9x2d:unset($Kh9tIMF);$Kh9tIMF=$Kh9MD;$ret[$key]['money']=$Kh9tIMF;unset($Kh9tIMC);$Kh9tIMC=C('BALANCE_STYLE')[$vo['style']];$ret[$key]['style']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['create_time']);$ret[$key]['create_time']=$Kh9tIMC;}$Kh9vPMC='余额明细' . time();$this->exportToExcel($Kh9vPMC,$field_arr,$ret);}public function integral_log(){unset($Kh9tIMC);$Kh9tIMC=array();$map=$Kh9tIMC;if(I('style'))goto Kh9eWjgx2g;goto Kh9ldMhx2g;Kh9eWjgx2g:unset($Kh9tIMC);$Kh9tIMC=I('style');$map['style']=$Kh9tIMC;goto Kh9x2f;Kh9ldMhx2g:Kh9x2f:if(I('id'))goto Kh9eWjgx2i;goto Kh9ldMhx2i;Kh9eWjgx2i:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['customer_id']=$Kh9tIMC;goto Kh9x2h;Kh9ldMhx2i:Kh9x2h:if(I('key'))goto Kh9eWjgx2k;goto Kh9ldMhx2k;Kh9eWjgx2k:$Kh9vPMC='%' . I('key');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['remark']=$Kh9tIME;goto Kh9x2j;Kh9ldMhx2k:Kh9x2j:$Kh9MC=(bool)I('end_time');if($Kh9MC)goto Kh9eWjgx2n;goto Kh9ldMhx2n;Kh9eWjgx2n:$Kh9MC=I('end_time')&&I('begin_time');goto Kh9x2m;Kh9ldMhx2n:Kh9x2m:if($Kh9MC)goto Kh9eWjgx2o;goto Kh9ldMhx2o;Kh9eWjgx2o:unset($Kh9tIMC);$Kh9tIMC=array('between',array(strtotime(I('begin_time')),strtotime(I('end_time'))));$map['create_time']=$Kh9tIMC;goto Kh9x2l;Kh9ldMhx2o:Kh9x2l:unset($Kh9tIMC);$Kh9tIMC=M('integral_log')->where($map)->order("id desc")->paginate(30);$list=$Kh9tIMC;$this->assign('_list',$list);return view();}public function customer_log(){unset($Kh9tIMC);$Kh9tIMC=array();$map=$Kh9tIMC;if(I('id'))goto Kh9eWjgx2q;goto Kh9ldMhx2q;Kh9eWjgx2q:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['customer_id']=$Kh9tIMC;goto Kh9x2p;Kh9ldMhx2q:Kh9x2p:if(I('key'))goto Kh9eWjgx2s;goto Kh9ldMhx2s;Kh9eWjgx2s:$Kh9vPMC='%' . I('key');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['log']=$Kh9tIME;goto Kh9x2r;Kh9ldMhx2s:Kh9x2r:unset($Kh9tIMC);$Kh9tIMC=M('customer_log')->where($map)->order("create_time desc")->paginate(30);$list=$Kh9tIMC;$this->assign('_list',$list);return view();}public function grade(){unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->order('sort asc,id asc')->select();$list=$Kh9tIMC;$this->assign('_list',$list);return view();}public function grade_edit(){if(request()->isPost())goto Kh9eWjgx2u;goto Kh9ldMhx2u;Kh9eWjgx2u:unset($Kh9tIMC);$Kh9tIMC=I('post.');$arr=$Kh9tIMC;if(I('id'))goto Kh9eWjgx2w;goto Kh9ldMhx2w;Kh9eWjgx2w:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->where(array('id'=>I('id')))->setField($arr);$data=$Kh9tIMC;if($data)goto Kh9eWjgx2y;goto Kh9ldMhx2y;Kh9eWjgx2y:return $this->success('保存成功');goto Kh9x2x;Kh9ldMhx2y:return $this->error('编辑失败');Kh9x2x:goto Kh9x2v;Kh9ldMhx2w:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->insertGetId($arr);$aid=$Kh9tIMC;if($aid)goto Kh9eWjgx31;goto Kh9ldMhx31;Kh9eWjgx31:AgentGrade::initPrice();return $this->success('新增成功');goto Kh9x3z;Kh9ldMhx31:return $this->error('新增失败');Kh9x3z:Kh9x2v:goto Kh9x2t;Kh9ldMhx2u:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);return view();Kh9x2t:}public function grade_deletes(){unset($Kh9tIMC);$Kh9tIMC=I('id');$id=$Kh9tIMC;if(M('customer')->where(array('grade_id'=>$id,'is_del'=>0))->find())goto Kh9eWjgx33;goto Kh9ldMhx33;Kh9eWjgx33:return $this->error('等级下还有会员，请先移除会员');goto Kh9x32;Kh9ldMhx33:Kh9x32:if(M('customer_grade')->where(array('id'=>$id))->delete())goto Kh9eWjgx35;goto Kh9ldMhx35;Kh9eWjgx35:M('customer_grade_price')->where(array('grade_id'=>$id))->delete();return $this->success('删除成功');goto Kh9x34;Kh9ldMhx35:return $this->error('删除失败');Kh9x34:}public function grade_copy(){unset($Kh9tIMC);$Kh9tIMC=I('id');$id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->where(array('id'=>$id))->find();$grade=$Kh9tIMC;$Kh9MC=!$grade;if($Kh9MC)goto Kh9eWjgx37;goto Kh9ldMhx37;Kh9eWjgx37:return $this->error('不存在的等级');goto Kh9x36;Kh9ldMhx37:Kh9x36:unset($grade['id']);$grade['grade_name']=$grade['grade_name'].'_复制';$Kh9nWMC=$grade['grade_name'];unset($Kh9tIMC);$Kh9tIMC=M('customer_grade')->insertGetId($grade);$newid=$Kh9tIMC;$Kh9MC=!$newid;if($Kh9MC)goto Kh9eWjgx39;goto Kh9ldMhx39;Kh9eWjgx39:return $this->error('复制错误');goto Kh9x38;Kh9ldMhx39:Kh9x38:$Kh9vPMC=$newid . ' as grade_id,product_id,ranges';unset($Kh9tIMD);$Kh9tIMD=M('customer_grade_price')->where(array('grade_id'=>$id))->field($Kh9vPMC)->select();$prices=$Kh9tIMD;M('customer_grade_price')->insertAll($prices);return $this->success('复制成功');}public function price(){AgentGrade::initPrice();if(I('grade_id'))goto Kh9eWjgx3b;goto Kh9ldMhx3b;Kh9eWjgx3b:unset($Kh9tIMC);$Kh9tIMC=I('grade_id');$map['gp.grade_id']=$Kh9tIMC;goto Kh9x3a;Kh9ldMhx3b:Kh9x3a:if(I('product_id'))goto Kh9eWjgx3d;goto Kh9ldMhx3d;Kh9eWjgx3d:unset($Kh9tIMC);$Kh9tIMC=I('product_id');$map['gp.product_id']=$Kh9tIMC;goto Kh9x3c;Kh9ldMhx3d:Kh9x3c:unset($Kh9tIMC);$Kh9tIMC=0;$map['p.is_del']=$Kh9tIMC;if(I('key'))goto Kh9eWjgx3f;goto Kh9ldMhx3f;Kh9eWjgx3f:$Kh9vPMC='%' . I('key');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['p.name|p.desc']=$Kh9tIME;goto Kh9x3e;Kh9ldMhx3f:Kh9x3e:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade_price gp')->join("product p",'p.id=gp.product_id')->join("customer_grade g",'g.id=gp.grade_id')->where($map)->field("gp.*,p.name,p.isp,p.desc,p.price,p.added,p.remark,g.grade_name")->order("p.type asc,p.sort asc")->select();$list=$Kh9tIMC;$this->assign('_list',$list);return view();}public function price_edit(){if(request()->isPost())goto Kh9eWjgx3h;goto Kh9ldMhx3h;Kh9eWjgx3h:unset($Kh9tIMC);$Kh9tIMC=I('post.');$arr=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('customer_grade_price')->where(array('id'=>I('id')))->setField($arr);$data=$Kh9tIMC;if($data)goto Kh9eWjgx3j;goto Kh9ldMhx3j;Kh9eWjgx3j:return $this->success('保存成功');goto Kh9x3i;Kh9ldMhx3j:return $this->error('编辑失败');Kh9x3i:goto Kh9x3g;Kh9ldMhx3h:unset($Kh9tIMC);$Kh9tIMC=M('customer_grade_price')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);return view();Kh9x3g:}public function up_password(){$Kh9MC=!I('id');$Kh9ME=(bool)$Kh9MC;$Kh9MF=!$Kh9ME;if($Kh9MF)goto Kh9eWjgx3m;goto Kh9ldMhx3m;Kh9eWjgx3m:$Kh9MD=!I('password');$Kh9ME=$Kh9MC||$Kh9MD;goto Kh9x3l;Kh9ldMhx3m:Kh9x3l:if($Kh9ME)goto Kh9eWjgx3n;goto Kh9ldMhx3n;Kh9eWjgx3n:return $this->error("请输入密码！");goto Kh9x3k;Kh9ldMhx3n:Kh9x3k:M('customer')->where(array('id'=>I('id')))->setField(array('password'=>dyr_encrypt(I('password'))));$Kh9vPMC='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),'修改密码',$Kh9vPMC);return $this->success('重置成功!');}public function reset_google_auth_secret(){unset($Kh9tIMC);$Kh9tIMC=GoogleAuth::verifyCode($this->adminuser['google_auth_secret'],I('verifycode'),1);$goret=$Kh9tIMC;$Kh9MC=!$goret;if($Kh9MC)goto Kh9eWjgx3p;goto Kh9ldMhx3p;Kh9eWjgx3p:return $this->error("谷歌身份验证码错误！");goto Kh9x3o;Kh9ldMhx3p:Kh9x3o:M('customer')->where(array('id'=>I('id')))->setField(array('google_auth_secret'=>''));$Kh9vPMC='管理员：' . $this->adminuser['nickname'];Createlog::customerLog(I('id'),'重置了用户谷歌验证码',$Kh9vPMC);return $this->success('重置成功');}public function balance_add(){unset($Kh9tIMC);$Kh9tIMC=floatval(I('money'));$money=$Kh9tIMC;$Kh9MC=$money==0;$Kh9ME=(bool)$Kh9MC;$Kh9MF=!$Kh9ME;if($Kh9MF)goto Kh9eWjgx3s;goto Kh9ldMhx3s;Kh9eWjgx3s:$Kh9MD=abs($money)>9999999;$Kh9ME=$Kh9MC||$Kh9MD;goto Kh9x3r;Kh9ldMhx3s:Kh9x3r:if($Kh9ME)goto Kh9eWjgx3t;goto Kh9ldMhx3t;Kh9eWjgx3t:return $this->error("金额错误！");goto Kh9x3q;Kh9ldMhx3t:Kh9x3q:unset($Kh9tIMC);$Kh9tIMC=I('remark');$remark=$Kh9tIMC;$Kh9MC=$remark=="";if($Kh9MC)goto Kh9eWjgx3v;goto Kh9ldMhx3v;Kh9eWjgx3v:return $this->error("备注必填！");goto Kh9x3u;Kh9ldMhx3v:Kh9x3u:$Kh9MC=$money>0;if($Kh9MC)goto Kh9eWjgx3x;goto Kh9ldMhx3x;Kh9eWjgx3x:$Kh9vPMC='管理员：' . $this->adminuser['nickname'];unset($Kh9tIMD);$Kh9tIMD=Balance::revenue(I('id'),$money,$remark,Balance::STYLE_RECHARGE,$Kh9vPMC);$ret=$Kh9tIMD;goto Kh9x3w;Kh9ldMhx3x:$Kh9vPMC='管理员：' . $this->adminuser['nickname'];unset($Kh9tIMD);$Kh9tIMD=Balance::expend(I('id'),abs($money),$remark,Balance::STYLE_RECHARGE,$Kh9vPMC);$ret=$Kh9tIMD;Kh9x3w:$Kh9MC=$ret['errno']!=0;if($Kh9MC)goto Kh9eWjgx4z;goto Kh9ldMhx4z;Kh9eWjgx4z:return $this->error($ret['errmsg']);goto Kh9x3y;Kh9ldMhx4z:Kh9x3y:return $this->success($ret['errmsg']);}public function hz_price(){unset($Kh9tIMC);$Kh9tIMC=M('customer')->where(array('id'=>I('customer_id')))->find();$customer=$Kh9tIMC;$Kh9MC=!$customer;if($Kh9MC)goto Kh9eWjgx42;goto Kh9ldMhx42;Kh9eWjgx42:return $this->error('未找到用户');goto Kh9x41;Kh9ldMhx42:Kh9x41:unset($Kh9tIMC);$Kh9tIMC=0;$map['p.is_del']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('key'));$key=$Kh9tIMC;if($key)goto Kh9eWjgx44;goto Kh9ldMhx44;Kh9eWjgx44:if(I('query_name'))goto Kh9eWjgx46;goto Kh9ldMhx46;Kh9eWjgx46:unset($Kh9tIMC);$Kh9tIMC=$key;$map[I('query_name')]=$Kh9tIMC;goto Kh9x45;Kh9ldMhx46:$Kh9vPMC='%' . $key;$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['p.name|p.desc']=$Kh9tIME;Kh9x45:goto Kh9x43;Kh9ldMhx44:Kh9x43:if(I('product_id'))goto Kh9eWjgx48;goto Kh9ldMhx48;Kh9eWjgx48:unset($Kh9tIMC);$Kh9tIMC=I('product_id');$map['p.id']=$Kh9tIMC;goto Kh9x47;Kh9ldMhx48:Kh9x47:unset($Kh9tIMC);$Kh9tIMC=ProductModel::getProducts($map,$customer['id']);$resdata=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$resdata['data'];$cates=$Kh9tIMC;foreach($cates as&$cate){foreach($cate['products']as&$item){unset($Kh9tIMC);$Kh9tIMC=M('customer_hezuo_price')->where(array('customer_id'=>$customer['id'],'product_id'=>$item['id']))->field('id as rangesid,ranges,ys_tag')->find();$hzprice=$Kh9tIMC;$Kh9MC=!$hzprice;if($Kh9MC)goto Kh9eWjgx4a;goto Kh9ldMhx4a;Kh9eWjgx4a:unset($Kh9tIMC);$Kh9tIMC='';$item['ys_tag']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$item['rangesid']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$item['ranges']=$Kh9tIMC;goto Kh9x49;Kh9ldMhx4a:unset($Kh9tIMC);$Kh9tIMC=$hzprice['ys_tag'];$item['ys_tag']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$hzprice['rangesid'];$item['rangesid']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$hzprice['ranges'];$item['ranges']=$Kh9tIMC;Kh9x49:}}$this->assign('_list',$cates);return view();}public function hz_price_edit(){unset($Kh9tIMC);$Kh9tIMC=I('id');$pr_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('product_id');$product_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('customer_id');$customer_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$map['p.is_del']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product_id;$map['p.id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('customer')->where(array('id'=>$customer_id))->find();$customer=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=ProductModel::getProduct($map,$customer['id']);$resdata=$Kh9tIMC;$Kh9MC=$resdata['errno']!=0;if($Kh9MC)goto Kh9eWjgx4c;goto Kh9ldMhx4c;Kh9eWjgx4c:return $this->error($resdata['errmsg']);goto Kh9x4b;Kh9ldMhx4c:Kh9x4b:unset($Kh9tIMC);$Kh9tIMC=$resdata['data'];$product=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=floatval(I('ranges'));$ranges=$Kh9tIMC;$Kh9MC=$ranges<0;if($Kh9MC)goto Kh9eWjgx4e;goto Kh9ldMhx4e;Kh9eWjgx4e:return $this->error('浮动金额不能小于0');goto Kh9x4d;Kh9ldMhx4e:Kh9x4d:$Kh9MC=floatval($product['max_price'])>0;$Kh9MF=(bool)$Kh9MC;if($Kh9MF)goto Kh9eWjgx4h;goto Kh9ldMhx4h;Kh9eWjgx4h:$Kh9MD=$product['price']+$ranges;$Kh9ME=$Kh9MD>$product['max_price'];$Kh9MF=$Kh9MC&&$Kh9ME;goto Kh9x4g;Kh9ldMhx4h:Kh9x4g:if($Kh9MF)goto Kh9eWjgx4i;goto Kh9ldMhx4i;Kh9eWjgx4i:return $this->error('不能设置高于封顶价格');goto Kh9x4f;Kh9ldMhx4i:Kh9x4f:unset($Kh9tIMC);$Kh9tIMC=CustomerHezuoPrice::saveValues($pr_id,$customer_id,$product_id,array('ranges'=>$ranges));$res=$Kh9tIMC;$Kh9MC=$res['errno']==0;if($Kh9MC)goto Kh9eWjgx4k;goto Kh9ldMhx4k;Kh9eWjgx4k:return $this->success('保存成功');goto Kh9x4j;Kh9ldMhx4k:return $this->error('编辑失败');Kh9x4j:}public function hz_price_ystag_edit(){unset($Kh9tIMC);$Kh9tIMC=CustomerHezuoPrice::saveValues(I('id'),I('customer_id'),I('product_id'),array('ys_tag'=>I('ys_tag')));$res=$Kh9tIMC;$Kh9MC=$res['errno']==0;if($Kh9MC)goto Kh9eWjgx4m;goto Kh9ldMhx4m;Kh9eWjgx4m:return $this->success('保存成功');goto Kh9x4l;Kh9ldMhx4m:return $this->error('编辑失败');Kh9x4l:}public function balance_check(){unset($Kh9tIMC);$Kh9tIMC=I('id');$id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('type'=>1,'customer_id'=>$id))->sum('money');$bsr=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('type'=>2,'customer_id'=>$id))->sum('money');$bzc=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('Customer')->where(array('id'=>$id))->value('balance');$balance=$Kh9tIMC;$Kh9vPvPMC=$bsr-$bzc;$Kh9vPvPMD=$Kh9vPvPMC-$balance;unset($Kh9tIME);$Kh9tIME=round(floatval($Kh9vPvPMD),2);$chva=$Kh9tIME;$Kh9MC=$chva==0;if($Kh9MC)goto Kh9eWjgx4o;goto Kh9ldMhx4o;Kh9eWjgx4o:return $this->success('校验通过');goto Kh9x4n;Kh9ldMhx4o:$Kh9vPMC="检验不通过，异常值建议：" . $chva;return $this->error($Kh9vPMC);Kh9x4n:}public function reset_apikey(){unset($Kh9tIMC);$Kh9tIMC=Random::alnum(32);$apikey=$Kh9tIMC;M('Customer')->where(array('id'=>I('id')))->setField(array('apikey'=>$apikey));return $this->success('重置成功');}public function month_bill(){unset($Kh9tIMC);$Kh9tIMC=I('id');$customer_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array();$data=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=strtotime(date("Y-m-01",time()));$cusmonth=$Kh9tIMC;$i=0;Kh9x4p:$Kh9MC=$i<12;if($Kh9MC)goto Kh9eWjgx4t;goto Kh9ldMhx4t;Kh9eWjgx4t:$Kh9vPMC='-' . $i;$Kh9vPMD=$Kh9vPMC . ' month';unset($Kh9tIME);$Kh9tIME=strtotime($Kh9vPMD,$cusmonth);unset($Kh9tIMC);$Kh9tIMC=$Kh9tIME;$start_time=$Kh9tIMC;$Kh9MC=strtotime('+1 month',$start_time)-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;unset($Kh9tIMC);$Kh9tIMC=$Kh9tIMD;$end_time=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=date("Y-m",$start_time);$arr['date']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('egt',$start_time),'customer_id'=>$customer_id))->order('create_time asc,id asc')->value('balance_pr');$arr['qichu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('elt',$end_time),'customer_id'=>$customer_id))->order('create_time desc,id desc')->value('balance');$arr['qimo']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'type'=>1,'style'=>4))->sum('money');$arr['jiakuan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$arr;$data[]=$Kh9tIMC;Kh9x4q:$Kh9oB201=$i;$Kh9oB202=$i+1;$i=$Kh9oB202;goto Kh9x4p;goto Kh9x4s;Kh9ldMhx4t:Kh9x4s:Kh9x4r:$this->assign('_list',$data);return view();}public function day_bill(){unset($Kh9tIMC);$Kh9tIMC=I('id');$customer_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array();$data=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=strtotime(date("Y-m-d",time()));$cusmonth=$Kh9tIMC;$i=0;Kh9x4u:$Kh9MC=$i<31;if($Kh9MC)goto Kh9eWjgx4y;goto Kh9ldMhx4y;Kh9eWjgx4y:$Kh9vPMC='-' . $i;$Kh9vPMD=$Kh9vPMC . ' day';unset($Kh9tIME);$Kh9tIME=strtotime($Kh9vPMD,$cusmonth);unset($Kh9tIMC);$Kh9tIMC=$Kh9tIME;$start_time=$Kh9tIMC;$Kh9MC=strtotime('+1 day',$start_time)-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;unset($Kh9tIMC);$Kh9tIMC=$Kh9tIMD;$end_time=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=date("Y-m-d",$start_time);$arr['date']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'status'=>array('not in',array(1,7))))->order('create_time asc,id asc')->count();$arr['dingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'status'=>array('not in',array(1,7))))->order('create_time asc,id asc')->sum('total_price');$arr['dingdanprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'finish_time'=>array('between',array($start_time,$end_time)),'status'=>array('in',array(4,12,13))))->order('finish_time asc,id asc')->count();$arr['cgdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'finish_time'=>array('between',array($start_time,$end_time)),'status'=>array('in',array(4,12,13))))->order('finish_time asc,id asc')->sum('total_price - refund_price');$arr['cgprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'style'=>2,'type'=>1))->order('create_time asc,id asc')->sum('money');$arr['flprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('egt',$start_time),'customer_id'=>$customer_id))->order('create_time asc,id asc')->value('balance_pr');$arr['qichu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('elt',$end_time),'customer_id'=>$customer_id))->order('create_time desc,id desc')->value('balance');$arr['qimo']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'type'=>1,'style'=>4))->sum('money');$arr['jiakuan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$arr;$data[]=$Kh9tIMC;Kh9x4v:$Kh9oB202=$i;$Kh9oB203=$i+1;$i=$Kh9oB203;goto Kh9x4u;goto Kh9x4x;Kh9ldMhx4y:Kh9x4x:Kh9x4w:$this->assign('_list',$data);return view();}public function day_price(){if(I('key'))goto Kh9eWjgx51;goto Kh9ldMhx51;Kh9eWjgx51:if(I('query_name'))goto Kh9eWjgx53;goto Kh9ldMhx53;Kh9eWjgx53:unset($Kh9tIMC);$Kh9tIMC=trim(I('key'));$map[I('query_name')]=$Kh9tIMC;goto Kh9x52;Kh9ldMhx53:$Kh9vPMC='%' . trim(I('key'));$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['username|mobile']=$Kh9tIME;Kh9x52:goto Kh9x5z;Kh9ldMhx51:Kh9x5z:if(I('is_subscribe'))goto Kh9eWjgx55;goto Kh9ldMhx55;Kh9eWjgx55:$Kh9MC=intval(I('is_subscribe'))-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$map['is_subscribe']=$Kh9tIMD;goto Kh9x54;Kh9ldMhx55:Kh9x54:if(I('id'))goto Kh9eWjgx57;goto Kh9ldMhx57;Kh9eWjgx57:unset($Kh9tIMC);$Kh9tIMC=I('id');$map['id']=$Kh9tIMC;goto Kh9x56;Kh9ldMhx57:Kh9x56:if(I('f_id'))goto Kh9eWjgx59;goto Kh9ldMhx59;Kh9eWjgx59:unset($Kh9tIMC);$Kh9tIMC=I('f_id');$map['f_id']=$Kh9tIMC;goto Kh9x58;Kh9ldMhx59:Kh9x58:if(I('client'))goto Kh9eWjgx5b;goto Kh9ldMhx5b;Kh9eWjgx5b:unset($Kh9tIMC);$Kh9tIMC=I('client');$map['client']=$Kh9tIMC;goto Kh9x5a;Kh9ldMhx5b:Kh9x5a:unset($Kh9tIMC);$Kh9tIMC=0;$map['is_del']=$Kh9tIMC;if(I('grade_id'))goto Kh9eWjgx5d;goto Kh9ldMhx5d;Kh9eWjgx5d:$Kh9MC=I('type')!=0;if($Kh9MC)goto Kh9eWjgx5f;goto Kh9ldMhx5f;Kh9eWjgx5f:unset($Kh9tIMC);$Kh9tIMC=I('grade_id');$map['grade_id']=$Kh9tIMC;goto Kh9x5e;Kh9ldMhx5f:Kh9x5e:goto Kh9x5c;Kh9ldMhx5d:Kh9x5c:if(I('type'))goto Kh9eWjgx5h;goto Kh9ldMhx5h;Kh9eWjgx5h:unset($Kh9tIMC);$Kh9tIMC=I('type');$map['type']=$Kh9tIMC;$this->assign("grades",M('customer_grade')->where(array('grade_type'=>I('type')))->order("sort asc,grade_type asc")->select());goto Kh9x5g;Kh9ldMhx5h:$this->assign("grades",array());Kh9x5g:unset($Kh9tIMC);$Kh9tIMC=strtotime(I('begin_time'));$start_time=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=strtotime(I('end_time'));$end_time=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumflprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumdingdanprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumcgdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumcgprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arr['sumjiakuan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('customer')->where($map)->order("id asc")->select();$customer=$Kh9tIMC;$Kh9MC=count($customer)>0;if($Kh9MC)goto Kh9eWjgx5j;goto Kh9ldMhx5j;Kh9eWjgx5j:foreach($customer as&$vo){unset($Kh9tIMC);$Kh9tIMC=array();$arr[]=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$vo['id'];$customer_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$vo['username'];$arr['username']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$vo['id'];$arr['id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'status'=>array('not in',array(1,7))))->order('create_time asc,id asc')->count();$arr['dingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'status'=>array('not in',array(1,7))))->order('create_time asc,id asc')->sum('total_price');$arr['dingdanprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'finish_time'=>array('between',array($start_time,$end_time)),'status'=>array('in',array(4,12,13))))->order('finish_time asc,id asc')->count();$arr['cgdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$customer_id,'finish_time'=>array('between',array($start_time,$end_time)),'status'=>array('in',array(4,12,13))))->order('finish_time asc,id asc')->sum('total_price - refund_price');$arr['cgprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'style'=>2,'type'=>1))->order('create_time asc,id asc')->sum('money');$arr['flprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('egt',$start_time),'customer_id'=>$customer_id))->order('create_time asc,id asc')->value('balance_pr');$arr['qichu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('create_time'=>array('elt',$end_time),'customer_id'=>$customer_id))->order('create_time desc,id desc')->value('balance');$arr['qimo']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('balance_log')->where(array('customer_id'=>$customer_id,'create_time'=>array('between',array($start_time,$end_time)),'type'=>1,'style'=>4))->sum('money');$arr['jiakuan']=$Kh9tIMC;$Kh9MC=floatval($arr['sumflprice'])+floatval($arr['flprice']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumflprice']=$Kh9tIMD;$Kh9MC=floatval($arr['sumdingdanshu'])+floatval($arr['dingdanshu']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumdingdanshu']=$Kh9tIMD;$Kh9MC=floatval($arr['sumdingdanprice'])+floatval($arr['dingdanprice']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumdingdanprice']=$Kh9tIMD;$Kh9MC=floatval($arr['sumcgdingdanshu'])+floatval($arr['cgdingdanshu']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumcgdingdanshu']=$Kh9tIMD;$Kh9MC=floatval($arr['sumcgprice'])+floatval($arr['cgprice']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumcgprice']=$Kh9tIMD;$Kh9MC=floatval($arr['sumjiakuan'])+floatval($arr['jiakuan']);unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$arr['sumjiakuan']=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=$arr;$data[]=$Kh9tIMC;}$this->assign('_list',$data);goto Kh9x5i;Kh9ldMhx5j:unset($Kh9tIMC);$Kh9tIMC='-';$arr['username']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['dingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['dingdanprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['cgdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['cgprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['flprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['qichu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['qimo']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='-';$arr['jiakuan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumflprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumdingdanprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumcgdingdanshu']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumcgprice']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$arrs['sumjiakuan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$arr;$datas[]=$Kh9tIMC;$this->assign('_list',$datas);Kh9x5i:return view();}}
?>