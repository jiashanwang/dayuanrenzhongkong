<?php
/*
 本代码由 成都大猿人网络科技有限公司 原创开发
 官方网址：www.dayuanren.cn
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace app\agent\controller;use app\api\controller\Notify;use app\common\library\Createlog;use app\common\model\Balance;use app\common\model\Client;use app\common\model\Porder as PorderModel;use app\common\model\Product;use app\common\model\Product as ProductModel;class Porder extends Admin{public function index(){unset($Kh9tIMC);$Kh9tIMC=$this->create_map();$map=$Kh9tIMC;if(I('sort'))goto Kh9eWjgx2;goto Kh9ldMhx2;Kh9eWjgx2:unset($Kh9tIMC);$Kh9tIMC=I('sort');$sort=$Kh9tIMC;goto Kh9x1;Kh9ldMhx2:unset($Kh9tIMC);$Kh9tIMC="id desc";$sort=$Kh9tIMC;Kh9x1:unset($Kh9tIMC);$Kh9tIMC=D('porder')->where($map)->field("*,(select type_name from dyr_product_type where id=type) as type_name")->order($sort)->paginate(C('LIST_ROWS'));$list=$Kh9tIMC;$this->assign('total_price',M('porder')->where($map)->sum("total_price"));$this->assign('_list',$list);$this->assign('_total',$list->total());$this->assign('_types',M('product_type')->where(array('status'=>1))->order('sort asc,id asc')->select());$this->assign('agent_cancel_sw',C('AGENT_CANCEL_SW'));return view();}private function create_map(){unset($Kh9tIMC);$Kh9tIMC=0;$map['is_del']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array('in',array(0,2));$map['is_apart']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$map['customer_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('key'));$key=$Kh9tIMC;if($Kh9tIMC)goto Kh9eWjgx4;goto Kh9ldMhx4;Kh9eWjgx4:unset($Kh9tIMC);$Kh9tIMC=I('query_name');$query_name=$Kh9tIMC;if($query_name)goto Kh9eWjgx6;goto Kh9ldMhx6;Kh9eWjgx6:$Kh9MC=strpos($query_name,'.')!==false;if($Kh9MC)goto Kh9eWjgx8;goto Kh9ldMhx8;Kh9eWjgx8:unset($Kh9tIMC);$Kh9tIMC=explode('.',$query_name);$qu_arr=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M($qu_arr[0])->where(array($qu_arr[1]=>$key))->field('id')->select();$qu_rets=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array('in',array_column($qu_rets,'id'));$map[$qu_arr[2]]=$Kh9tIMC;goto Kh9x7;Kh9ldMhx8:unset($Kh9tIMC);$Kh9tIMC=$key;$map[$query_name]=$Kh9tIMC;Kh9x7:goto Kh9x5;Kh9ldMhx6:$Kh9vPMC='%' . $key;$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['order_number|title|product_name|mobile|out_trade_num|api_order_number|guishu|remark|isp']=$Kh9tIME;Kh9x5:goto Kh9x3;Kh9ldMhx4:Kh9x3:if(I('status'))goto Kh9eWjgxa;goto Kh9ldMhxa;Kh9eWjgxa:unset($Kh9tIMC);$Kh9tIMC=array('in',I('status'));$map['status']=$Kh9tIMC;goto Kh9x9;Kh9ldMhxa:if(I('status2'))goto Kh9eWjgxc;goto Kh9ldMhxc;Kh9eWjgxc:unset($Kh9tIMC);$Kh9tIMC=array('in',I('status2'));$map['status']=$Kh9tIMC;goto Kh9xb;Kh9ldMhxc:Kh9xb:Kh9x9:if(I('is_notification'))goto Kh9eWjgxe;goto Kh9ldMhxe;Kh9eWjgxe:$Kh9MC=intval(I('is_notification'))-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$map['is_notification']=$Kh9tIMD;goto Kh9xd;Kh9ldMhxe:Kh9xd:if(I('apply_refund'))goto Kh9eWjgxg;goto Kh9ldMhxg;Kh9eWjgxg:$Kh9MC=intval(I('apply_refund'))-1;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$map['apply_refund']=$Kh9tIMD;goto Kh9xf;Kh9ldMhxg:Kh9xf:if(I('type'))goto Kh9eWjgxi;goto Kh9ldMhxi;Kh9eWjgxi:unset($Kh9tIMC);$Kh9tIMC=I('type');$map['type']=$Kh9tIMC;goto Kh9xh;Kh9ldMhxi:Kh9xh:if(I('isp'))goto Kh9eWjgxk;goto Kh9ldMhxk;Kh9eWjgxk:unset($Kh9tIMC);$Kh9tIMC=getISPText(I('isp'));$map['isp']=$Kh9tIMC;goto Kh9xj;Kh9ldMhxk:Kh9xj:$Kh9MC=(bool)I('end_time');if($Kh9MC)goto Kh9eWjgxn;goto Kh9ldMhxn;Kh9eWjgxn:$Kh9MC=I('end_time')&&I('begin_time');goto Kh9xm;Kh9ldMhxn:Kh9xm:if($Kh9MC)goto Kh9eWjgxo;goto Kh9ldMhxo;Kh9eWjgxo:if(I('time_style'))goto Kh9eWjgxq;goto Kh9ldMhxq;Kh9eWjgxq:$Kh9MC=I('time_style');goto Kh9xp;Kh9ldMhxq:$Kh9MC='create_time';Kh9xp:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$time_style=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=array('between',array(strtotime(I('begin_time')),strtotime(I('end_time'))));$map[$time_style]=$Kh9tIMC;goto Kh9xl;Kh9ldMhxo:Kh9xl:if(I('excel_id'))goto Kh9eWjgxs;goto Kh9ldMhxs;Kh9eWjgxs:unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('customer_id'=>$this->user['id'],'excel_id'=>I('excel_id')))->field('order_number')->select();$porderes=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array('in',array_column($porderes,'order_number'));$map['order_number']=$Kh9tIMC;goto Kh9xr;Kh9ldMhxs:Kh9xr:if(I('batch_mobile'))goto Kh9eWjgxu;goto Kh9ldMhxu;Kh9eWjgxu:unset($Kh9tIMC);$Kh9tIMC=str_replace(' ','',str_replace(array("
","
","
"),",",I('batch_mobile')));$batch_order_number=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=preg_grep('/\\S+/',explode(',',$batch_order_number));$bt_mo=$Kh9tIMC;$Kh9MD=(bool)$bt_mo;if($Kh9MD)goto Kh9eWjgxw;goto Kh9ldMhxw;Kh9eWjgxw:unset($Kh9tIMC);$Kh9tIMC=array("in",$bt_mo);unset($Kh9tIME);$Kh9tIME=$Kh9tIMC;$map['mobile']=$Kh9tIME;$Kh9MD=$bt_mo&&$Kh9tIMC;goto Kh9xv;Kh9ldMhxw:Kh9xv:goto Kh9xt;Kh9ldMhxu:Kh9xt:if(I('batch_order_number'))goto Kh9eWjgxy;goto Kh9ldMhxy;Kh9eWjgxy:unset($Kh9tIMC);$Kh9tIMC=str_replace(' ','',str_replace(array("
","
","
"),",",I('batch_order_number')));$batch_order_number=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=preg_grep('/\\S+/',explode(',',$batch_order_number));$bt_mo=$Kh9tIMC;$Kh9MD=(bool)$bt_mo;if($Kh9MD)goto Kh9eWjgx11;goto Kh9ldMhx11;Kh9eWjgx11:unset($Kh9tIMC);$Kh9tIMC=array("in",$bt_mo);unset($Kh9tIME);$Kh9tIME=$Kh9tIMC;$map['order_number']=$Kh9tIME;$Kh9MD=$bt_mo&&$Kh9tIMC;goto Kh9xz;Kh9ldMhx11:Kh9xz:goto Kh9xx;Kh9ldMhxy:Kh9xx:if(I('batch_out_trade_num'))goto Kh9eWjgx13;goto Kh9ldMhx13;Kh9eWjgx13:unset($Kh9tIMC);$Kh9tIMC=str_replace(' ','',str_replace(array("
","
","
"),",",I('batch_out_trade_num')));$batch_order_number=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=preg_grep('/\\S+/',explode(',',$batch_order_number));$bt_mo=$Kh9tIMC;$Kh9MD=(bool)$bt_mo;if($Kh9MD)goto Kh9eWjgx15;goto Kh9ldMhx15;Kh9eWjgx15:unset($Kh9tIMC);$Kh9tIMC=array("in",$bt_mo);unset($Kh9tIME);$Kh9tIME=$Kh9tIMC;$map['out_trade_num']=$Kh9tIME;$Kh9MD=$bt_mo&&$Kh9tIMC;goto Kh9x14;Kh9ldMhx15:Kh9x14:goto Kh9x12;Kh9ldMhx13:Kh9x12:return $map;}public function out_excel(){unset($Kh9tIMC);$Kh9tIMC=$this->create_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where($map)->field('*,(select type_name from dyr_product_type where id=type) as type_name')->order("create_time desc")->select();$ret=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array(array('title'=>'系统单号','field'=>'order_number'),array('title'=>'商户单号','field'=>'out_trade_num'),array('title'=>'类型','field'=>'type_name'),array('title'=>'产品ID','field'=>'product_id'),array('title'=>'产品','field'=>'product_name'),array('title'=>'手机','field'=>'mobile'),array('title'=>'归属地','field'=>'guishu'),array('title'=>'运营商','field'=>'isp'),array('title'=>'扩展','field'=>'param'),array('title'=>'状态','field'=>'status'),array('title'=>'总金额','field'=>'total_price'),array('title'=>'已冲金额','field'=>'charge_amount'),array('title'=>'支付时间','field'=>'pay_time'),array('title'=>'下单时间','field'=>'create_time'),array('title'=>'完成时间','field'=>'finish_time'),array('title'=>'备注','field'=>'remark'),array('title'=>'用户标记','field'=>'user_lable'),array('title'=>'回调地址','field'=>'notify_url'),array('title'=>'回调时间','field'=>'notification_time'),array('title'=>'凭证','field'=>'voucher'),array('title'=>'卡密/流水','field'=>'charge_kami'));$field_arr=$Kh9tIMC;foreach($ret as $key=>$vo){unset($Kh9tIMC);$Kh9tIMC=C('PORDER_STATUS')[$vo['status']];$ret[$key]['status']=$Kh9tIMC;$Kh9MC=$vo['param1'] . '/';$Kh9MD=$Kh9MC . $vo['param2'];$Kh9ME=$Kh9MD . '/';$Kh9MF=$Kh9ME . $vo['param3'];$Kh9MG=$Kh9MF . '/';unset($Kh9tIMH);$Kh9tIMH=$Kh9MG;$ret[$key]['param']=$Kh9tIMH;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['pay_time']);$ret[$key]['pay_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['create_time']);$ret[$key]['create_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['finish_time']);$ret[$key]['finish_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($vo['notification_time']);$ret[$key]['notification_time']=$Kh9tIMC;$Kh9MC=$vo['charge_amount']==0;if($Kh9MC)goto Kh9eWjgx17;goto Kh9ldMhx17;Kh9eWjgx17:$Kh9MD='/';goto Kh9x16;Kh9ldMhx17:$Kh9MD=$vo['charge_amount'];Kh9x16:unset($Kh9tIME);$Kh9tIME=$Kh9MD;$ret[$key]['charge_amount']=$Kh9tIME;$Kh9MC=$vo['status']==4;if($Kh9MC)goto Kh9eWjgx19;goto Kh9ldMhx19;Kh9eWjgx19:$Kh9MD=C('WEB_URL') . "yrapi.php/open/voucher/id/";$Kh9ME=$Kh9MD . $vo['id'];$Kh9MF=$Kh9ME . '.html';$Kh9MG=$Kh9MF;goto Kh9x18;Kh9ldMhx19:$Kh9MG='';Kh9x18:unset($Kh9tIMH);$Kh9tIMH=$Kh9MG;$ret[$key]['voucher']=$Kh9tIMH;}$Kh9vPMC='充值订单报表' . time_format(time());$this->exportToExcel($Kh9vPMC,$field_arr,$ret);}public function orders(){unset($Kh9tIMC);$Kh9tIMC=M('electricity_city')->where(array('is_del'=>0,'pid'=>0))->order('initial asc,sort asc')->select();$areas=$Kh9tIMC;$this->assign('areas',$areas);$this->assign('ytypes',C('ELE_YTYPE'));return view();}public function get_city(){unset($Kh9tIMC);$Kh9tIMC=M('electricity_city')->where(array('is_del'=>0,'pid'=>I('pid')))->order('initial asc,sort asc')->select();$areas=$Kh9tIMC;return rjson(0,'ok',$areas);}public function get_product(){unset($Kh9tIMC);$Kh9tIMC=array();$data=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('product_type')->where(array('status'=>1))->order('sort asc,id asc')->select();$types=$Kh9tIMC;foreach($types as $key=>$type){unset($Kh9tIMC);$Kh9tIMC=array('p.is_del'=>0,'p.added'=>1);$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$type['id'];$map['p.type']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array('in','1,3');$map['p.show_style']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='';$prov=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC='';$city=$Kh9tIMC;$Kh9MD=(bool)in_array($type['id'],array(1,2));if($Kh9MD)goto Kh9eWjgx1c;goto Kh9ldMhx1c;Kh9eWjgx1c:unset($Kh9tIMC);$Kh9tIMC=I('mobile');unset($Kh9tIME);$Kh9tIME=$Kh9tIMC;$mobile=$Kh9tIME;$Kh9MD=in_array($type['id'],array(1,2))&&$Kh9tIMC;goto Kh9x1b;Kh9ldMhx1c:Kh9x1b:if($Kh9MD)goto Kh9eWjgx1d;goto Kh9ldMhx1d;Kh9eWjgx1d:unset($Kh9tIMC);$Kh9tIMC=QCellCore($mobile);$guishu=$Kh9tIMC;$Kh9MC=$guishu['errno']==0;if($Kh9MC)goto Kh9eWjgx1f;goto Kh9ldMhx1f;Kh9eWjgx1f:unset($Kh9tIMC);$Kh9tIMC=Product::Ispzhan($mobile,$this->user['id'],$guishu);$guishu=$Kh9tIMC;$Kh9vPMC='%' . $guishu['data']['isp'];$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['p.isp']=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['prov'];$prov=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['city'];$city=$Kh9tIMC;goto Kh9x1e;Kh9ldMhx1f:Kh9x1e:goto Kh9x1a;Kh9ldMhx1d:Kh9x1a:unset($Kh9tIMC);$Kh9tIMC=ProductModel::getTypec($type['typec_id']);$typec=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=ProductModel::getProducts($map,$this->user['id'],$prov,$city);$resdata=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$resdata['data'];$lists=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array('type'=>$type['id'],'name'=>$type['type_name'],'typec'=>$typec,'lists'=>$lists);$data[]=$Kh9tIMC;}return djson(0,'ok',array('product'=>$data));}public function get_guishu(){unset($Kh9tIMC);$Kh9tIMC=I('mobile');$mobile=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=QCellCore($mobile);$guishu=$Kh9tIMC;$Kh9MC=$guishu['errno']!=0;if($Kh9MC)goto Kh9eWjgx1h;goto Kh9ldMhx1h;Kh9eWjgx1h:return djson($guishu['errno'],$guishu['errmsg']);goto Kh9x1g;Kh9ldMhx1h:Kh9x1g:unset($Kh9tIMC);$Kh9tIMC=Product::Ispzhan($mobile,$this->user['id'],$guishu);$guishu=$Kh9tIMC;return djson(0,'ok',$guishu['data']);}public function create_order(){unset($Kh9tIMC);$Kh9tIMC=trim(I('mobile'));$mobile=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('product_id');$product_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('area'));$area=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('id_card_no'));$id_card_no=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('city'));$city=$Kh9tIMC;if(I('ytype'))goto Kh9eWjgx1j;goto Kh9ldMhx1j;Kh9eWjgx1j:$Kh9MC=trim(I('ytype'));goto Kh9x1i;Kh9ldMhx1j:$Kh9MC=1;Kh9x1i:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$ytype=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=trim(I('param1'));$param1=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('param2'));$param2=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim(I('param3'));$param3=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=PorderModel::createOrder($mobile,$product_id,array('prov'=>$area,'city'=>$city,'ytype'=>$ytype,'id_card_no'=>$id_card_no,'param1'=>$param1,'param2'=>$param2,'param3'=>$param3),$this->user['id'],Client::CLIENT_AGA,'');$res=$Kh9tIMC;$Kh9MC=$res['errno']!=0;if($Kh9MC)goto Kh9eWjgx1l;goto Kh9ldMhx1l;Kh9eWjgx1l:return djson($res['errno'],$res['errmsg'],$res['data']);goto Kh9x1k;Kh9ldMhx1l:Kh9x1k:unset($Kh9tIMC);$Kh9tIMC=$res['data'];$aid=$Kh9tIMC;PorderModel::compute_rebate($aid);Createlog::porderLog($aid,"代理商后台下单成功");unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>$aid))->field("id,order_number,mobile,product_id,total_price,create_time,guishu,title,out_trade_num")->find();$porder=$Kh9tIMC;$Kh9vPMC="[支付]代理商后台为账号：" . $porder['mobile'];$Kh9vPMD=$Kh9vPMC . ",充值产品：";$Kh9vPME=$Kh9vPMD . $porder['title'];$Kh9vPMF=$Kh9vPME . "，单号";$Kh9vPMG=$Kh9vPMF . $porder['order_number'];unset($Kh9tIMH);$Kh9tIMH=Balance::expend($this->user['id'],$porder['total_price'],$Kh9vPMG,Balance::STYLE_ORDERS,'代理商_手工');$ret=$Kh9tIMH;$Kh9MC=$ret['errno']!=0;if($Kh9MC)goto Kh9eWjgx1n;goto Kh9ldMhx1n;Kh9eWjgx1n:$Kh9vPMC="代理商后台下单时支付失败，取消订单，原因：" . $ret['errmsg'];PorderModel::payFailCancelOrder($aid,$Kh9vPMC);return djson($ret['errno'],$ret['errmsg']);goto Kh9x1m;Kh9ldMhx1n:Kh9x1m:Createlog::porderLog($aid,"余额支付成功");$Kh9MC=new Notify();unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$noticy=$Kh9tIMD;$noticy->balance($porder['order_number']);return djson(0,"下单成功");}public function order_batch(){return view();}public function excels(){unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$map['customer_id']=$Kh9tIMC;if(I('key'))goto Kh9eWjgx1p;goto Kh9ldMhx1p;Kh9eWjgx1p:$Kh9vPMC='%' . I('key');$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['name']=$Kh9tIME;goto Kh9x1o;Kh9ldMhx1p:Kh9x1o:if(I('type'))goto Kh9eWjgx1r;goto Kh9ldMhx1r;Kh9eWjgx1r:unset($Kh9tIMC);$Kh9tIMC=I('type');$map['type']=$Kh9tIMC;goto Kh9x1q;Kh9ldMhx1r:Kh9x1q:$Kh9MC=(bool)I('end_time');if($Kh9MC)goto Kh9eWjgx1u;goto Kh9ldMhx1u;Kh9eWjgx1u:$Kh9MC=I('end_time')&&I('begin_time');goto Kh9x1t;Kh9ldMhx1u:Kh9x1t:if($Kh9MC)goto Kh9eWjgx1v;goto Kh9ldMhx1v;Kh9eWjgx1v:unset($Kh9tIMC);$Kh9tIMC=array('between',array(strtotime(I('begin_time')),strtotime(I('end_time'))));$map['create_time']=$Kh9tIMC;goto Kh9x1s;Kh9ldMhx1v:Kh9x1s:unset($Kh9tIMC);$Kh9tIMC=M('agent_excel')->where($map)->order('id desc')->paginate(C('LIST_ROWS'))->each(function($item,$key){unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id']))->field('order_number')->select();$es=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id']))->count();$item['all_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id'],'status'=>1))->count();$item['weidao_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id'],'status'=>array('in',array(2,3))))->count();$item['daoruing_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id'],'status'=>array('in',4)))->count();$item['daorus_sus_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$item['id'],'status'=>array('in',5)))->count();$item['daorus_fail_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'order_number'=>array('in',array_column($es,'order_number'))))->select();$porders=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=count($porders);$item['daoru_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',array_column($porders,'id')),'status'=>array('in','2,3,8,9,10,11')))->count();$item['ing_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',array_column($porders,'id')),'status'=>array('in','4,12,13')))->count();$item['sus_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',array_column($porders,'id')),'status'=>array('in','5,6,7')))->count();$item['fail_count']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',array_column($porders,'id')),'status'=>array('in','2,3,4,5,6,8,9,10,11,12,13')))->sum('total_price');$item['total_price']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',array_column($porders,'id')),'status'=>array('in','6,13')))->sum('refund_price');$item['refund_price']=$Kh9tIMC;return $item;});$list=$Kh9tIMC;$this->assign('_list',$list);return view();}public function excels_out(){unset($Kh9tIMC);$Kh9tIMC=M('agent_excel')->where(array('id'=>I('id'),'customer_id'=>$this->user['id']))->find();$exc=$Kh9tIMC;$Kh9MC=!$exc;if($Kh9MC)goto Kh9eWjgx1x;goto Kh9ldMhx1x;Kh9eWjgx1x:return $this->error('没有该导入文件');goto Kh9x1w;Kh9ldMhx1x:Kh9x1w:unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->where(array('excel_id'=>$exc['id']))->field('order_number')->select();$porderes=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'order_number'=>array('in',array_column($porderes,'order_number'))))->field('*,(select type_name from dyr_product_type where id=type) as type_name')->select();$porders=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array(array('title'=>'平台单号','field'=>'order_number'),array('title'=>'商户单号','field'=>'out_trade_num'),array('title'=>'类型','field'=>'type_name'),array('title'=>'产品ID','field'=>'product_id'),array('title'=>'产品','field'=>'product_name'),array('title'=>'手机','field'=>'mobile'),array('title'=>'归属地','field'=>'guishu'),array('title'=>'运营商','field'=>'isp'),array('title'=>'状态','field'=>'status'),array('title'=>'总金额','field'=>'total_price'),array('title'=>'支付时间','field'=>'pay_time'),array('title'=>'下单时间','field'=>'create_time'),array('title'=>'完成时间','field'=>'finish_time'),array('title'=>'扩展1','field'=>'param1'),array('title'=>'扩展2','field'=>'param2'),array('title'=>'扩展3','field'=>'param3'));$field_arr=$Kh9tIMC;foreach($porders as&$item){unset($Kh9tIMC);$Kh9tIMC=C('PORDER_STATUS')[$item['status']];$item['status']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($item['pay_time']);$item['pay_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($item['create_time']);$item['create_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($item['finish_time']);$item['finish_time']=$Kh9tIMC;}$Kh9vPMC=$exc['name'] . '-';$Kh9vPMD=$Kh9vPMC . time_format($exc['create_time']);$this->exportToExcel($Kh9vPMD,$field_arr,$porders);}public function in_excel(){if(request()->isPost())goto Kh9eWjgx2z;goto Kh9ldMhx2z;Kh9eWjgx2z:vendor("phpexcel.PHPExcel");unset($Kh9tIMC);$Kh9tIMC=request()->file('excel');$file=$Kh9tIMC;if(empty($file))goto Kh9eWjgx22;goto Kh9ldMhx22;Kh9eWjgx22:return $this->error('请选择上传文件');goto Kh9x21;Kh9ldMhx22:Kh9x21:unset($Kh9tIMC);$Kh9tIMC=$file->validate(array('size'=>C('DOWNLOAD_UPLOAD.maxSize'),'ext'=>'xlsx'))->move(C('DOWNLOAD_UPLOAD.movePath'));$info=$Kh9tIMC;if($info)goto Kh9eWjgx24;goto Kh9ldMhx24;Kh9eWjgx24:unset($Kh9tIMC);$Kh9tIMC=$info->getSaveName();$exclePath=$Kh9tIMC;$Kh9MC=C('DOWNLOAD_UPLOAD.movePath') . DS;$Kh9MD=$Kh9MC . $exclePath;unset($Kh9tIME);$Kh9tIME=$Kh9MD;$file_name=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=\PHPExcel_IOFactory::createReader("Excel2007");$objReader=$Kh9tIMC;unset($Kh9tIvPMC);$Kh9tIvPMC='utf-8';$encode=$Kh9tIvPMC;unset($Kh9tIMD);$Kh9tIMD=$objReader->load($file_name,$Kh9tIvPMC);$obj_PHPExcel=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=$obj_PHPExcel->getSheet(0)->toArray();$excel_array=$Kh9tIMC;array_shift($excel_array);unset($Kh9tIMC);$Kh9tIMC=M('agent_excel')->insertGetId(array('type'=>2,'customer_id'=>$this->user['id'],'name'=>$file->getInfo()['name'],'create_time'=>time()));$excel_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array();$tirow=$Kh9tIMC;foreach($excel_array as $k=>$v){unset($Kh9tIMC);$Kh9tIMC=trim($v[0]);$product_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=trim($v[1]);$mobile=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$v[2];$remark=$Kh9tIMC;if(isset($v[3]))goto Kh9eWjgx26;goto Kh9ldMhx26;Kh9eWjgx26:$Kh9MC=trim($v[3]);goto Kh9x25;Kh9ldMhx26:$Kh9MC='';Kh9x25:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$out_trade_num=$Kh9tIMD;if(isset($v[4]))goto Kh9eWjgx28;goto Kh9ldMhx28;Kh9eWjgx28:$Kh9MC=trim($v[4]);goto Kh9x27;Kh9ldMhx28:$Kh9MC='';Kh9x27:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$prov=$Kh9tIMD;if(isset($v[5]))goto Kh9eWjgx2a;goto Kh9ldMhx2a;Kh9eWjgx2a:$Kh9MC=trim($v[5]);goto Kh9x29;Kh9ldMhx2a:$Kh9MC='';Kh9x29:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$id_card_no=$Kh9tIMD;if(isset($v[6]))goto Kh9eWjgx2c;goto Kh9ldMhx2c;Kh9eWjgx2c:$Kh9MC=trim($v[6]);goto Kh9x2b;Kh9ldMhx2c:$Kh9MC=1;Kh9x2b:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$ytype=$Kh9tIMD;if(isset($v[7]))goto Kh9eWjgx2e;goto Kh9ldMhx2e;Kh9eWjgx2e:$Kh9MC=trim($v[7]);goto Kh9x2d;Kh9ldMhx2e:$Kh9MC='';Kh9x2d:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$city=$Kh9tIMD;$Kh9MC=$k+2;$Kh9MD='  #第[' . $Kh9MC;$Kh9ME=$Kh9MD . '行]';unset($Kh9tIMF);$Kh9tIMF=$Kh9ME;$hangstr=$Kh9tIMF;unset($Kh9tIMC);$Kh9tIMC=M('product')->where(array('id'=>$product_id,'is_del'=>0))->value('type');$product_type=$Kh9tIMC;if(in_array($product_type,array(1,2)))goto Kh9eWjgx2g;goto Kh9ldMhx2g;Kh9eWjgx2g:unset($Kh9tIMC);$Kh9tIMC=QCellCore($mobile);$guishu=$Kh9tIMC;$Kh9MC=$guishu['errno']!=0;if($Kh9MC)goto Kh9eWjgx2i;goto Kh9ldMhx2i;Kh9eWjgx2i:$Kh9vPMC='归属地未找到:' . $mobile;$Kh9vPMD=$Kh9vPMC . ',';$Kh9vPME=$Kh9vPMD . $guishu['errmsg'];$Kh9vPMF=$Kh9vPME . $hangstr;return $this->error($Kh9vPMF,'','',20);goto Kh9x2h;Kh9ldMhx2i:Kh9x2h:unset($Kh9tIMC);$Kh9tIMC=Product::Ispzhan($mobile,$this->user['id'],$guishu);$guishu=$Kh9tIMC;$Kh9vPMC='%' . $guishu['data']['isp'];$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['p.isp']=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['ispstr'];$tirow[$k]['isp']=$Kh9tIMC;$Kh9MC=$guishu['data']['prov'] . $guishu['data']['city'];unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$tirow[$k]['guishu']=$Kh9tIMD;$Kh9MC=$guishu['data']['ispstr'] . ',';$Kh9MD=$Kh9MC . $hangstr;unset($Kh9tIME);$Kh9tIME=$Kh9MD;$hangstr=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['prov'];$prov=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['city'];$city=$Kh9tIMC;goto Kh9x2f;Kh9ldMhx2g:Kh9x2f:unset($Kh9tIMC);$Kh9tIMC=$product_id;$map['p.id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$map['p.added']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=ProductModel::getProduct($map,$this->user['id'],$prov,$city);$resdata=$Kh9tIMC;$Kh9MC=$resdata['errno']!=0;if($Kh9MC)goto Kh9eWjgx2k;goto Kh9ldMhx2k;Kh9eWjgx2k:$Kh9vPMC='未找到匹配的充值产品，' . $resdata['errmsg'];$Kh9vPMD=$Kh9vPMC . '，套餐id:';$Kh9vPME=$Kh9vPMD . $product_id;$Kh9vPMF=$Kh9vPME . '，手机：';$Kh9vPMG=$Kh9vPMF . $mobile;$Kh9vPMH=$Kh9vPMG . '，';$Kh9vPMI=$Kh9vPMH . $hangstr;return $this->error($Kh9vPMI,'','',20);goto Kh9x2j;Kh9ldMhx2k:Kh9x2j:unset($Kh9tIMC);$Kh9tIMC=$resdata['data'];$product=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product_id;$tirow[$k]['product_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$mobile;$tirow[$k]['mobile']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$remark;$tirow[$k]['remark']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$prov;$tirow[$k]['area']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$city;$tirow[$k]['city']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$ytype;$tirow[$k]['ytype']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$id_card_no;$tirow[$k]['id_card_no']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['name'];$tirow[$k]['product_name']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['price'];$tirow[$k]['total_price']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['desc'];$tirow[$k]['product_desc']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['api_open'];$tirow[$k]['api_open']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['api_arr'];$tirow[$k]['api_arr']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=-1;$tirow[$k]['api_cur_index']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['type'];$tirow[$k]['type']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$tirow[$k]['status']=$Kh9tIMC;$Kh9MC=$k+2;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$tirow[$k]['hang']=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$tirow[$k]['customer_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$excel_id;$tirow[$k]['excel_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time();$tirow[$k]['create_time']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$out_trade_num;$tirow[$k]['out_trade_num']=$Kh9tIMC;}unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->insertAll($tirow);$sh=$Kh9tIMC;$Kh9vPMC='成功导入' . $sh;$Kh9vPMD=$Kh9vPMC . '条数据,即将进入推送页面';return $this->success($Kh9vPMD,U('porder_excel',array('status'=>1,'excel_id'=>$excel_id)));goto Kh9x23;Kh9ldMhx24:return $this->error($file->getError());Kh9x23:goto Kh9x1y;Kh9ldMhx2z:return view();Kh9x1y:}public function batch_in(){unset($Kh9tIMC);$Kh9tIMC=$_POST['mobiles'];$mobile_str=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=json_decode($mobile_str,true);$mobiles=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('product_id');$product_id=$Kh9tIMC;$Kh9vPvPMC="批量下单" . date('Y-m-d H:i',time());unset($Kh9tIMD);$Kh9tIMD=M('agent_excel')->insertGetId(array('type'=>1,'customer_id'=>$this->user['id'],'name'=>$Kh9vPvPMC,'create_time'=>time()));$excel_id=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=array();$tirow=$Kh9tIMC;foreach($mobiles as $k=>$hang){unset($Kh9tIMC);$Kh9tIMC=trim($hang[0]);$mobile=$Kh9tIMC;if(isset($hang[1]))goto Kh9eWjgx2m;goto Kh9ldMhx2m;Kh9eWjgx2m:$Kh9MC=trim($hang[1]);goto Kh9x2l;Kh9ldMhx2m:$Kh9MC='';Kh9x2l:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$prov=$Kh9tIMD;if(isset($hang[2]))goto Kh9eWjgx2o;goto Kh9ldMhx2o;Kh9eWjgx2o:$Kh9MC=trim($hang[2]);goto Kh9x2n;Kh9ldMhx2o:$Kh9MC='';Kh9x2n:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$id_card_no=$Kh9tIMD;if(isset($hang[3]))goto Kh9eWjgx2q;goto Kh9ldMhx2q;Kh9eWjgx2q:$Kh9MC=trim($hang[3]);goto Kh9x2p;Kh9ldMhx2q:$Kh9MC=1;Kh9x2p:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$ytype=$Kh9tIMD;if(isset($hang[4]))goto Kh9eWjgx2s;goto Kh9ldMhx2s;Kh9eWjgx2s:$Kh9MC=trim($hang[4]);goto Kh9x2r;Kh9ldMhx2s:$Kh9MC='';Kh9x2r:unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$city=$Kh9tIMD;$Kh9MC=$k+1;$Kh9MD='  #第[' . $Kh9MC;$Kh9ME=$Kh9MD . '行]';unset($Kh9tIMF);$Kh9tIMF=$Kh9ME;$hangstr=$Kh9tIMF;unset($Kh9tIMC);$Kh9tIMC=M('product')->where(array('id'=>$product_id,'is_del'=>0))->value('type');$product_type=$Kh9tIMC;if(in_array($product_type,array(1,2)))goto Kh9eWjgx2u;goto Kh9ldMhx2u;Kh9eWjgx2u:$Kh9MC=!is_numeric($mobile);$Kh9ME=(bool)$Kh9MC;$Kh9MF=!$Kh9ME;if($Kh9MF)goto Kh9eWjgx2x;goto Kh9ldMhx2x;Kh9eWjgx2x:$Kh9MD=mb_strlen($mobile)!=11;$Kh9ME=$Kh9MC||$Kh9MD;goto Kh9x2w;Kh9ldMhx2x:Kh9x2w:if($Kh9ME)goto Kh9eWjgx2y;goto Kh9ldMhx2y;Kh9eWjgx2y:return $this->error('手机号格式不正确');goto Kh9x2v;Kh9ldMhx2y:Kh9x2v:unset($Kh9tIMC);$Kh9tIMC=QCellCore($mobile);$guishu=$Kh9tIMC;$Kh9MC=$guishu['errno']!=0;if($Kh9MC)goto Kh9eWjgx31;goto Kh9ldMhx31;Kh9eWjgx31:$Kh9vPMC='归属地未找到:' . $mobile;$Kh9vPMD=$Kh9vPMC . ',';$Kh9vPME=$Kh9vPMD . $guishu['errmsg'];$Kh9vPMF=$Kh9vPME . $hangstr;return $this->error($Kh9vPMF,'','',20);goto Kh9x3z;Kh9ldMhx31:Kh9x3z:unset($Kh9tIMC);$Kh9tIMC=Product::Ispzhan($mobile,$this->user['id'],$guishu);$guishu=$Kh9tIMC;$Kh9vPMC='%' . $guishu['data']['isp'];$Kh9vPMD=$Kh9vPMC . '%';unset($Kh9tIME);$Kh9tIME=array('like',$Kh9vPMD);$map['p.isp']=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['ispstr'];$tirow[$k]['isp']=$Kh9tIMC;$Kh9MC=$guishu['data']['prov'] . $guishu['data']['city'];unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$tirow[$k]['guishu']=$Kh9tIMD;$Kh9MC=$guishu['data']['ispstr'] . ',';$Kh9MD=$Kh9MC . $hangstr;unset($Kh9tIME);$Kh9tIME=$Kh9MD;$hangstr=$Kh9tIME;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['prov'];$prov=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$guishu['data']['city'];$city=$Kh9tIMC;goto Kh9x2t;Kh9ldMhx2u:Kh9x2t:unset($Kh9tIMC);$Kh9tIMC=$product_id;$map['p.id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$map['p.added']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=ProductModel::getProduct($map,$this->user['id'],$prov,$city);$resdata=$Kh9tIMC;$Kh9MC=$resdata['errno']!=0;if($Kh9MC)goto Kh9eWjgx33;goto Kh9ldMhx33;Kh9eWjgx33:$Kh9vPMC='未找到匹配的充值产品，' . $resdata['errmsg'];$Kh9vPMD=$Kh9vPMC . '，套餐id:';$Kh9vPME=$Kh9vPMD . $product_id;$Kh9vPMF=$Kh9vPME . '，手机：';$Kh9vPMG=$Kh9vPMF . $mobile;$Kh9vPMH=$Kh9vPMG . '，';$Kh9vPMI=$Kh9vPMH . $hangstr;return $this->error($Kh9vPMI,'','',20);goto Kh9x32;Kh9ldMhx33:Kh9x32:unset($Kh9tIMC);$Kh9tIMC=$resdata['data'];$product=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product_id;$tirow[$k]['product_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$mobile;$tirow[$k]['mobile']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['name'];$tirow[$k]['remark']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$prov;$tirow[$k]['area']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$city;$tirow[$k]['city']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$ytype;$tirow[$k]['ytype']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$id_card_no;$tirow[$k]['id_card_no']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['name'];$tirow[$k]['product_name']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['price'];$tirow[$k]['total_price']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['desc'];$tirow[$k]['product_desc']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['api_open'];$tirow[$k]['api_open']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['api_arr'];$tirow[$k]['api_arr']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=-1;$tirow[$k]['api_cur_index']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$product['type'];$tirow[$k]['type']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$tirow[$k]['status']=$Kh9tIMC;$Kh9MC=$k+2;unset($Kh9tIMD);$Kh9tIMD=$Kh9MC;$tirow[$k]['hang']=$Kh9tIMD;unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$tirow[$k]['customer_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$excel_id;$tirow[$k]['excel_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time();$tirow[$k]['create_time']=$Kh9tIMC;}unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel')->insertAll($tirow);$sh=$Kh9tIMC;$Kh9vPMC='成功生成' . $sh;$Kh9vPMD=$Kh9vPMC . '条数据,即将进入推送页面';return $this->success($Kh9vPMD,U('porder_excel',array('status'=>1,'excel_id'=>$excel_id)));}public function up_agent_excel(){unset($Kh9tIMC);$Kh9tIMC=I('post.');$arr=$Kh9tIMC;unset($arr['id']);M('agent_excel')->where(array('id'=>I('id'),'customer_id'=>$this->user['id']))->setField($arr);return $this->success('修改成功');}public function porder_excel(){unset($Kh9tIMC);$Kh9tIMC=$this->porder_excel_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel p')->join('agent_excel e','e.id=p.excel_id')->where($map)->field('p.*,e.name as excel_name,(select type_name from dyr_product_type where id=p.type) as type_name')->order('p.id desc')->select();$list=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$alljy_pt=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$alljy_dr=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=0;$total_price=$Kh9tIMC;foreach($list as&$item){unset($Kh9tIMC);$Kh9tIMC=floatval(preg_replace('/\\D/','',$item['product_name']));$item['ptjiaoyan']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=floatval(preg_replace('/\\D/','',$item['remark']));$item['drjiaoyan']=$Kh9tIMC;$Kh9MC=$item['ptjiaoyan']==$item['drjiaoyan'];if($Kh9MC)goto Kh9eWjgx35;goto Kh9ldMhx35;Kh9eWjgx35:$Kh9MD=1;goto Kh9x34;Kh9ldMhx35:$Kh9MD=0;Kh9x34:unset($Kh9tIME);$Kh9tIME=$Kh9MD;$item['jy_jg']=$Kh9tIME;$alljy_dr=$alljy_dr+$item['drjiaoyan'];$Kh9nWMC=$alljy_dr;$alljy_pt=$alljy_pt+$item['ptjiaoyan'];$Kh9nWMC=$alljy_pt;$total_price=$total_price+$item['total_price'];$Kh9nWMC=$total_price;}$this->assign('alljy_pt',$alljy_pt);$this->assign('alljy_dr',$alljy_dr);$Kh9vPMC=$alljy_pt==$alljy_dr;if($Kh9vPMC)goto Kh9eWjgx37;goto Kh9ldMhx37;Kh9eWjgx37:$Kh9vPMD=1;goto Kh9x36;Kh9ldMhx37:$Kh9vPMD=0;Kh9x36:$this->assign('alljy_jg',$Kh9vPMD);$this->assign('total_price',$total_price);$this->assign('reapi',M('reapi')->where(array('is_del'=>0))->select());$this->assign('_list',$list);return view();}public function porder_excel_out(){unset($Kh9tIMC);$Kh9tIMC=$this->porder_excel_map();$map=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel p')->join('agent_excel e','e.id=p.excel_id')->where($map)->field('p.*,e.name as excel_name,(select type_name from dyr_product_type where id=p.type) as type_name')->order('p.id desc')->select();$list=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=array(array('title'=>'表格名称','field'=>'excel_name'),array('title'=>'行','field'=>'hang'),array('title'=>'商户单号','field'=>'out_trade_num'),array('title'=>'类型','field'=>'type_name'),array('title'=>'产品ID','field'=>'product_id'),array('title'=>'产品','field'=>'product_name'),array('title'=>'手机','field'=>'mobile'),array('title'=>'归属地','field'=>'guishu'),array('title'=>'运营商','field'=>'isp'),array('title'=>'状态','field'=>'status'),array('title'=>'系统单号','field'=>'order_number'),array('title'=>'总金额','field'=>'total_price'),array('title'=>'生成时间','field'=>'create_time'),array('title'=>'提单结果','field'=>'resmsg'));$field_arr=$Kh9tIMC;foreach($list as&$item){unset($Kh9tIMC);$Kh9tIMC=C('PORDER_EXCEL_STATUS')[$item['status']];$item['status']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=time_format($item['create_time']);$item['create_time']=$Kh9tIMC;}$Kh9vPMC='导出表格-' . time_format(time());$this->exportToExcel($Kh9vPMC,$field_arr,$list);}public function zuofei_porder_excel(){if(M('agent_proder_excel')->where(array('id'=>I('id'),'customer_id'=>$this->user['id']))->setField(array('status'=>5)))goto Kh9eWjgx39;goto Kh9ldMhx39;Kh9eWjgx39:return $this->success('作废成功');goto Kh9x38;Kh9ldMhx39:return $this->error('作废失败');Kh9x38:}public function zuofei_all_porder_excel(){unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$map['customer_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$map['status']=$Kh9tIMC;M('agent_proder_excel')->where($map)->setField(array('status'=>5));return $this->success('作废成功');}public function push_excel(){set_time_limit(0);unset($Kh9tIMC);$Kh9tIMC=I('excel_id');$excel_id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=1;$map['p.status']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=$excel_id;$map['p.excel_id']=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('agent_proder_excel p')->join('agent_excel e','e.id=p.excel_id')->where($map)->field('p.id')->select();$list=$Kh9tIMC;$Kh9MC=!$list;if($Kh9MC)goto Kh9eWjgx3b;goto Kh9ldMhx3b;Kh9eWjgx3b:return $this->error('没有可推送的数据');goto Kh9x3a;Kh9ldMhx3b:Kh9x3a:M('agent_proder_excel')->where(array('id'=>array('in',array_column($list,'id'))))->setField(array('status'=>2));queue('app\\queue\\job\\Work@agentPushExcel',$list);$Kh9vPMC='成功确认' . count($list);$Kh9vPMD=$Kh9vPMC . '条！请刷新待推送列表查看';return $this->success($Kh9vPMD,U('porder_excel',array('excel_id'=>$excel_id)));}private function porder_excel_map(){unset($Kh9tIMC);$Kh9tIMC=$this->user['id'];$map['p.customer_id']=$Kh9tIMC;if(I('status2'))goto Kh9eWjgx3d;goto Kh9ldMhx3d;Kh9eWjgx3d:unset($Kh9tIMC);$Kh9tIMC=array('in',I('status2'));$map['p.status']=$Kh9tIMC;goto Kh9x3c;Kh9ldMhx3d:Kh9x3c:if(I('status'))goto Kh9eWjgx3f;goto Kh9ldMhx3f;Kh9eWjgx3f:unset($Kh9tIMC);$Kh9tIMC=I('status');$map['p.status']=$Kh9tIMC;goto Kh9x3e;Kh9ldMhx3f:Kh9x3e:if(I('excel_id'))goto Kh9eWjgx3h;goto Kh9ldMhx3h;Kh9eWjgx3h:unset($Kh9tIMC);$Kh9tIMC=I('excel_id');$map['p.excel_id']=$Kh9tIMC;goto Kh9x3g;Kh9ldMhx3h:Kh9x3g:return $map;}public function notification(){unset($Kh9tIMC);$Kh9tIMC=PorderModel::notification(I('id'));$ret=$Kh9tIMC;$Kh9MC=$ret['errno']!=0;if($Kh9MC)goto Kh9eWjgx3j;goto Kh9ldMhx3j;Kh9eWjgx3j:return $this->error($ret['errmsg']);goto Kh9x3i;Kh9ldMhx3j:Kh9x3i:return $this->success($ret['errmsg']);}public function complaint(){unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'is_del'=>0,'id'=>I('porder_id')))->find();$porder=$Kh9tIMC;$Kh9MC=!$porder;if($Kh9MC)goto Kh9eWjgx3l;goto Kh9ldMhx3l;Kh9eWjgx3l:return $this->error("订单不存在");goto Kh9x3k;Kh9ldMhx3l:Kh9x3k:$this->assign('info',$porder);return view();}public function complaint_sub(){unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'is_del'=>0,'id'=>I('id')))->find();$porder=$Kh9tIMC;$Kh9MC=!$porder;if($Kh9MC)goto Kh9eWjgx3n;goto Kh9ldMhx3n;Kh9eWjgx3n:return djson(1,'订单未找到');goto Kh9x3m;Kh9ldMhx3n:Kh9x3m:M('porder_complaint')->insertGetId(array('customer_id'=>$this->user['id'],'porder_id'=>$porder['id'],'name'=>I('name'),'mobile'=>I('mobile'),'issue'=>I('issue'),'create_time'=>time(),'status'=>1));return djson(0,'投诉提交成功，等待平台处理');}public function apply_cancel_order(){$Kh9MC=C('AGENT_CANCEL_SW')!=1;if($Kh9MC)goto Kh9eWjgx3p;goto Kh9ldMhx3p;Kh9eWjgx3p:return djson(1,'功能关闭');goto Kh9x3o;Kh9ldMhx3p:Kh9x3o:unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'is_del'=>0,'id'=>I('id')))->find();$porder=$Kh9tIMC;$Kh9MC=!$porder;if($Kh9MC)goto Kh9eWjgx3r;goto Kh9ldMhx3r;Kh9eWjgx3r:return djson(1,'订单未找到');goto Kh9x3q;Kh9ldMhx3r:Kh9x3q:$Kh9vPMC="代理-[" . $this->user['id'];$Kh9vPMD=$Kh9vPMC . ']';$Kh9vPME=$Kh9vPMD . $this->user['username'];return PorderModel::applyCancelOrder(array($porder['id']),$Kh9vPME);}public function set_aprefunds(){unset($Kh9tIMC);$Kh9tIMC=I('id/a');$ids=$Kh9tIMC;$Kh9vPMC="代理后台批量申请退单-" . $this->user['username'];return PorderModel::applyCancelOrder($ids,$Kh9vPMC);}public function lables(){if(request()->isPost())goto Kh9eWjgx3t;goto Kh9ldMhx3t;Kh9eWjgx3t:unset($Kh9tIMC);$Kh9tIMC=I('id/a');$ids=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>array('in',$ids)))->field('id,lable')->select();$porders=$Kh9tIMC;$Kh9MC=!$porders;if($Kh9MC)goto Kh9eWjgx3v;goto Kh9ldMhx3v;Kh9eWjgx3v:return $this->error('订单未找到');goto Kh9x3u;Kh9ldMhx3v:Kh9x3u:unset($Kh9tIMC);$Kh9tIMC=I('lable');$lable=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=I('prompt_remark');$prompt_remark=$Kh9tIMC;foreach($porders as $porder){if($prompt_remark)goto Kh9eWjgx3x;goto Kh9ldMhx3x;Kh9eWjgx3x:if($porder['lable'])goto Kh9eWjgx4z;goto Kh9ldMhx4z;Kh9eWjgx4z:$Kh9vPvPMC=$porder['lable'] . ',';$Kh9vPvPMD=$Kh9vPvPMC . $prompt_remark;$Kh9vPvPME=$Kh9vPvPMD;goto Kh9x3y;Kh9ldMhx4z:$Kh9vPvPME=$prompt_remark;Kh9x3y:M('porder')->where(array('id'=>$porder['id']))->setField(array('lable'=>$Kh9vPvPME));$Kh9vPMC='批量增加标签:' . $prompt_remark;$Kh9vPMD=$Kh9vPMC . '|代理端|';$Kh9vPME=$Kh9vPMD . "代理-[";$Kh9vPMF=$Kh9vPME . $this->user['id'];$Kh9vPMG=$Kh9vPMF . ']';$Kh9vPMH=$Kh9vPMG . $this->user['username'];Createlog::porderLog($porder['id'],$Kh9vPMH);goto Kh9x3w;Kh9ldMhx3x:M('porder')->where(array('id'=>$porder['id']))->setField(array('lable'=>$lable));$Kh9vPMC='设置标签:' . $lable;$Kh9vPMD=$Kh9vPMC . '|代理端|';$Kh9vPME=$Kh9vPMD . "代理-[";$Kh9vPMF=$Kh9vPME . $this->user['id'];$Kh9vPMG=$Kh9vPMF . ']';$Kh9vPMH=$Kh9vPMG . $this->user['username'];Createlog::porderLog($porder['id'],$Kh9vPMH);Kh9x3w:}return $this->success('添加成功');goto Kh9x3s;Kh9ldMhx3t:unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);$this->assign('lables',explode(',',C('PORDER_LABLES')));return view();Kh9x3s:}public function lable(){if(request()->isPost())goto Kh9eWjgx42;goto Kh9ldMhx42;Kh9eWjgx42:unset($Kh9tIMC);$Kh9tIMC=I('id');$id=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('customer_id'=>$this->user['id'],'id'=>$id))->find();$porder=$Kh9tIMC;$Kh9MC=!$porder;if($Kh9MC)goto Kh9eWjgx44;goto Kh9ldMhx44;Kh9eWjgx44:return $this->error('订单未找到');goto Kh9x43;Kh9ldMhx44:Kh9x43:unset($Kh9tIMC);$Kh9tIMC=I('lable');$lable=$Kh9tIMC;unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>$id))->setField(array('user_lable'=>$lable));$data=$Kh9tIMC;if($data)goto Kh9eWjgx46;goto Kh9ldMhx46;Kh9eWjgx46:$Kh9vPMC='修改标签:' . $lable;$Kh9vPMD=$Kh9vPMC . '|代理端|';$Kh9vPME=$Kh9vPMD . "代理-[";$Kh9vPMF=$Kh9vPME . $this->user['id'];$Kh9vPMG=$Kh9vPMF . ']';$Kh9vPMH=$Kh9vPMG . $this->user['username'];Createlog::porderLog($porder['id'],$Kh9vPMH);return $this->success('保存成功');goto Kh9x45;Kh9ldMhx46:return $this->error('保存失败');Kh9x45:goto Kh9x41;Kh9ldMhx42:unset($Kh9tIMC);$Kh9tIMC=M('porder')->where(array('id'=>I('id')))->find();$info=$Kh9tIMC;$this->assign('info',$info);$this->assign('lables',explode(',',C('PORDER_LABLES')));return view();Kh9x41:}}
?>