<?php
/*
 本代码由 成都大猿人网络科技有限公司 原创开发
 官方网址：www.dayuanren.cn
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace Recharge;$GLOBALS["AA__A_"]="in_array";$GLOBALS["A_AA_A"]="stripos";$GLOBALS["A__AAA"]="rtrim";$GLOBALS["A____A"]="str_replace";$GLOBALS["A___A_"]="md5";use app\common\model\Porder as PorderModel;class Jiebxd{private $uid;private $key;private $apiurl;private $notify_url;public function __construct($option){if(isset($option['param1']))goto H7oeWjgx2;goto H7oldMhx2;H7oeWjgx2:$H7oD1=$option['param1'];goto H7ox1;H7oldMhx2:$H7oD1='';H7ox1:unset($H7otID2);$H7otID2=$H7oD1;$this->uid=$H7otID2;if(isset($option['param2']))goto H7oeWjgx4;goto H7oldMhx4;H7oeWjgx4:$H7oD1=$option['param2'];goto H7ox3;H7oldMhx4:$H7oD1='';H7ox3:unset($H7otID2);$H7otID2=$H7oD1;$this->key=$H7otID2;if(isset($option['param3']))goto H7oeWjgx6;goto H7oldMhx6;H7oeWjgx6:$H7oD1=$option['param3'];goto H7ox5;H7oldMhx6:$H7oD1='';H7ox5:unset($H7otID2);$H7otID2=$H7oD1;$this->notify_url=$H7otID2;if(isset($option['param4']))goto H7oeWjgx8;goto H7oldMhx8;H7oeWjgx8:$H7oD1=$option['param4'];goto H7ox7;H7oldMhx8:$H7oD1='';H7ox7:unset($H7otID2);$H7otID2=$H7oD1;$this->apiurl=$H7otID2;}public function recharge($out_trade_num,$mobile,$param,$isp=''){unset($H7otID1);$H7otID1=$GLOBALS["A____A"]('省','',$GLOBALS["A____A"]('市','',$isp));$AAAA_=$H7otID1;unset($H7otID1);$H7otID1=$GLOBALS["A____A"]('市','',$param['oparam3']);$AAAAA=$H7otID1;unset($H7otID1);$H7otID1=["province"=>$AAAA_,"city"=>$AAAAA,"type"=>1,"partner_no"=>$this->uid,"order_no"=>$out_trade_num,"account"=>$mobile,"amount"=>$param['param1'],"goods_id"=>$param['param2'],"notify_url"=>$this->notify_url];$A_____=$H7otID1;$H7oD2=(bool)isset($param['oparam1']);if($H7oD2)goto H7oeWjgxa;goto H7oldMhxa;H7oeWjgxa:unset($H7otID1);$H7otID1=$param['oparam1'];unset($H7otID3);$H7otID3=$H7otID1;$A_____['ext']=$H7otID3;$H7oD2=isset($param['oparam1'])&&$H7otID1;goto H7ox9;H7oldMhxa:H7ox9:$H7ovPD1=$this->get_ascii_url_params($A_____) . '&partner_key=';$H7ovPD2=$H7ovPD1 . $this->key;unset($H7otID3);$H7otID3=$GLOBALS["A___A_"]($H7ovPD2);$A_____['sign']=$H7otID3;return $this->http_post($this->apiurl,$A_____);}function get_ascii_url_params(array $params=[]){unset($H7otID1);$H7otID1='';$A___AA=$H7otID1;$H7oD1=!empty($params);if($H7oD1)goto H7oeWjgxc;goto H7oldMhxc;H7oeWjgxc:unset($H7otID1);$H7otID1=$params;$A__A__=$H7otID1;ksort($A__A__);foreach($A__A__ as $A__A_A=>$A__AA_){$H7oD1=!empty($A__AA_);if($H7oD1)goto H7oeWjgxe;goto H7oldMhxe;H7oeWjgxe:$H7oD1=$A__A_A . '=';$H7oD2=$H7oD1 . $A__AA_;$H7oD3=$H7oD2 . '&';$A___AA=$A___AA.$H7oD3;$H7onWD4=$A___AA;goto H7oxd;H7oldMhxe:H7oxd:}unset($H7otID1);$H7otID1=$GLOBALS["A__AAA"]($A___AA,'&');$A___AA=$H7otID1;goto H7oxb;H7oldMhxc:H7oxb:return $A___AA;}function http_post($url,$param){unset($H7otID1);$H7otID1=curl_init();$A_A___=$H7otID1;$H7oD1=$GLOBALS["A_AA_A"]($url,"https://")!==FALSE;if($H7oD1)goto H7oeWjgxg;goto H7oldMhxg;H7oeWjgxg:curl_setopt($A_A___,CURLOPT_SSL_VERIFYPEER,FALSE);curl_setopt($A_A___,CURLOPT_SSL_VERIFYHOST,false);curl_setopt($A_A___,CURLOPT_SSLVERSION,1);goto H7oxf;H7oldMhxg:H7oxf:if(is_string($param))goto H7oeWjgxi;goto H7oldMhxi;H7oeWjgxi:unset($H7otID1);$H7otID1=$param;$A_A__A=$H7otID1;goto H7oxh;H7oldMhxi:unset($H7otID1);$H7otID1=http_build_query($param);$A_A__A=$H7otID1;H7oxh:curl_setopt($A_A___,CURLOPT_URL,$url);curl_setopt($A_A___,CURLOPT_RETURNTRANSFER,1);curl_setopt($A_A___,CURLOPT_POST,true);curl_setopt($A_A___,CURLOPT_CONNECTTIMEOUT,30);curl_setopt($A_A___,CURLOPT_TIMEOUT,90);curl_setopt($A_A___,CURLOPT_POSTFIELDS,$A_A__A);curl_setopt($A_A___,CURLOPT_HTTPHEADER,["ContentType:application/x-www-form-urlencoded;charset=utf-8"]);unset($H7otID1);$H7otID1=curl_exec($A_A___);$A_A_A_=$H7otID1;unset($H7otID1);$H7otID1=curl_getinfo($A_A___);$A_A_AA=$H7otID1;curl_close($A_A___);$H7oD1=intval($A_A_AA["http_code"])==200;if($H7oD1)goto H7oeWjgxk;goto H7oldMhxk;H7oeWjgxk:unset($H7otID1);$H7otID1=json_decode($A_A_A_,true);$A_AA__=$H7otID1;$H7oD1=$A_AA__['code']==0;if($H7oD1)goto H7oeWjgxm;goto H7oldMhxm;H7oeWjgxm:return rjson(0,$A_AA__['msg'],$A_AA__);goto H7oxl;H7oldMhxm:return rjson(1,$A_AA__['msg'],$A_AA__);H7oxl:goto H7oxj;H7oldMhxk:$H7ovPD1='接口访问失败，http错误码' . $A_A_AA["http_code"];return rjson(500,$H7ovPD1);H7oxj:}public function check($out_trade_num){unset($H7otID1);$H7otID1=["partner_no"=>$this->uid,"order_no"=>$out_trade_num];$A_AAA_=$H7otID1;$H7ovPD1=$this->get_ascii_url_params($A_AAA_) . '&partner_key=';$H7ovPD2=$H7ovPD1 . $this->key;unset($H7otID3);$H7otID3=$GLOBALS["A___A_"]($H7ovPD2);$A_AAA_['sign']=$H7otID3;return $this->http_post($GLOBALS["A____A"]('create','query',$this->apiurl),$A_AAA_);}public function remove($out_trade_num){unset($H7otID1);$H7otID1=["partner_no"=>$this->uid,"order_no"=>$out_trade_num];$A_AAAA=$H7otID1;$H7ovPD1=$this->get_ascii_url_params($A_AAAA) . '&partner_key=';$H7ovPD2=$H7ovPD1 . $this->key;unset($H7otID3);$H7otID3=$GLOBALS["A___A_"]($H7ovPD2);$A_AAAA['sign']=$H7otID3;return $this->http_post($GLOBALS["A____A"]('create','cancel',$this->apiurl),$A_AAAA);}public function selfcheck($param){unset($H7otID1);$H7otID1=M('reapi')->where(['id'=>$param['api_cur_id']])->value('param1');$AA____=$H7otID1;$H7oD1=!$AA____;if($H7oD1)goto H7oeWjgxo;goto H7oldMhxo;H7oeWjgxo:return ;goto H7oxn;H7oldMhxo:H7oxn:unset($H7otID1);$H7otID1=$this->check($param['api_order_number']);$AA___A=$H7otID1;$H7oD1=$AA___A['errno']==0;$H7oD2=(bool)$H7oD1;if($H7oD2)goto H7oeWjgxt;goto H7oldMhxt;H7oeWjgxt:$H7oD2=$H7oD1&&isset($AA___A['data']['data']['status']);goto H7oxs;H7oldMhxt:H7oxs:$H7oD4=(bool)$H7oD2;if($H7oD4)goto H7oeWjgxr;goto H7oldMhxr;H7oeWjgxr:$H7oD3=$AA___A['data']['data']['partnerId']==$AA____;$H7oD4=$H7oD2&&$H7oD3;goto H7oxq;H7oldMhxr:H7oxq:if($H7oD4)goto H7oeWjgxu;goto H7oldMhxu;H7oeWjgxu:$H7oD1=$AA___A['data']['result']['status']==3;if($H7oD1)goto H7oeWjgxw;goto H7oldMhxw;H7oeWjgxw:PorderModel::rechargeSusApi('jiebxd',$param['api_order_number'],$AA___A['data']);goto H7oxv;H7oldMhxw:$H7oGiWq=$GLOBALS["AA__A_"]($AA___A['data']['result']['status'],[0,4,5]);if($H7oGiWq)goto H7oeWjgxx;goto H7oldMhxx;H7oeWjgxx:$H7oD1=$AA___A['data']['result']['amount_received']!=$AA___A['data']['result']['amount'];$H7oD3=(bool)$H7oD1;if($H7oD3)goto H7oeWjgx11;goto H7oldMhx11;H7oeWjgx11:$H7oD2=$AA___A['data']['result']['amount_received']>0;$H7oD3=$H7oD1&&$H7oD2;goto H7oxz;H7oldMhx11:H7oxz:if($H7oD3)goto H7oeWjgx12;goto H7oldMhx12;H7oeWjgx12:PorderModel::rechargeRateApi('jiebxd',$param['api_order_number'],$AA___A['data'],$AA___A['data']['result']['amount_received']);goto H7oxy;H7oldMhx12:H7oxy:goto H7oxv;H7oldMhxx:H7oxv:goto H7oxp;H7oldMhxu:H7oxp:}public function notify(){if(I('selfcheck'))goto H7oeWjgx14;goto H7oldMhx14;H7oeWjgx14:unset($H7otID1);$H7otID1=M('porder p')->join('reapi r','r.id=p.api_cur_id')->where(['r.callapi'=>'Jiebxd','p.status'=>3])->order('p.pegging_time asc ,p.create_time asc')->limit(100)->field('p.id,p.mobile,p.api_order_number,p.api_trade_num,p.api_cur_param_id,p.api_cur_id')->select();$AA__AA=$H7otID1;foreach($AA__AA as $AA_A__=>$AA_A_A){unset($H7otID1);$H7otID1=M('reapi')->where(['id'=>$AA_A_A['api_cur_id']])->find();$AA_AA_=$H7otID1;$H7oD1=new Jiebxd($AA_AA_);unset($H7otID2);$H7otID2=$H7oD1;$AA_AAA=$H7otID2;unset($H7otID1);$H7otID1=$AA_AAA->check($AA_A_A['api_order_number']);$AAA___=$H7otID1;M('porder')->where(['id'=>$AA_A_A['id']])->setField(['pegging_time'=>time()]);$H7oD1=$AAA___['errno']==0;$H7oD2=(bool)$H7oD1;if($H7oD2)goto H7oeWjgx17;goto H7oldMhx17;H7oeWjgx17:$H7oD2=$H7oD1&&isset($AAA___['data']['result']['status']);goto H7ox16;H7oldMhx17:H7ox16:if($H7oD2)goto H7oeWjgx18;goto H7oldMhx18;H7oeWjgx18:$H7oD1=$AAA___['data']['result']['status']==3;if($H7oD1)goto H7oeWjgx1a;goto H7oldMhx1a;H7oeWjgx1a:PorderModel::rechargeSusApi('jiebxd',$AA_A_A['api_order_number'],$AAA___['data']);goto H7ox19;H7oldMhx1a:$H7oGiWq=$GLOBALS["AA__A_"]($AAA___['data']['result']['status'],[0,2,4]);if($H7oGiWq)goto H7oeWjgx1b;goto H7oldMhx1b;H7oeWjgx1b:$H7oD1=$AAA___['data']['result']['amount_received']!=$AAA___['data']['result']['amount'];$H7oD3=(bool)$H7oD1;if($H7oD3)goto H7oeWjgx1e;goto H7oldMhx1e;H7oeWjgx1e:$H7oD2=$AAA___['data']['result']['amount_received']>0;$H7oD3=$H7oD1&&$H7oD2;goto H7ox1d;H7oldMhx1e:H7ox1d:if($H7oD3)goto H7oeWjgx1f;goto H7oldMhx1f;H7oeWjgx1f:$H7ovPvPD1="已充值：" . $AAA___['data']['result']['amount_received'];M('porder')->where(['id'=>$AA_A_A['id'],'status'=>['in',[3]]])->setField(['remark'=>$H7ovPvPD1]);$H7oD1="已充值:" . $AA_A_A['api_order_number'];$H7oD2=$H7oD1 . '-';$H7oD3=$H7oD2 . $AAA___['data']['result']['amount_received'];$H7oD4=$H7oD3 . '<br/>';echo $H7oD4;goto H7ox1c;H7oldMhx1f:H7ox1c:goto H7ox19;H7oldMhx1b:H7ox19:goto H7ox15;H7oldMhx18:H7ox15:}goto H7ox13;H7oldMhx14:if(I('remove'))goto H7oeWjgx1g;goto H7oldMhx1g;H7oeWjgx1g:unset($H7otID1);$H7otID1=M('porder p')->join('reapi r','r.id=p.api_cur_id')->where(['r.callapi'=>'Jiebxd','p.status'=>3,'apply_refund'=>1])->order('p.pegging_time asc ,p.create_time asc')->limit(100)->field('p.id,p.mobile,p.api_order_number,p.api_trade_num,p.api_cur_param_id,p.api_cur_id')->select();$AA__AA=$H7otID1;foreach($AA__AA as $AA_A__=>$AA_A_A){unset($H7otID1);$H7otID1=M('reapi')->where(['id'=>$AA_A_A['api_cur_id']])->find();$AA_AA_=$H7otID1;$H7oD1=new Jiebxd($AA_AA_);unset($H7otID2);$H7otID2=$H7oD1;$AA_AAA=$H7otID2;unset($H7otID1);$H7otID1=$AA_AAA->remove($AA_A_A['api_order_number']);$AAA___=$H7otID1;$H7oD1=$AAA___['data']['code']==0;if($H7oD1)goto H7oeWjgx1i;goto H7oldMhx1i;H7oeWjgx1i:$H7oD1=$AA_A_A['api_order_number'] . '-撤单提交成功！<br/>';echo $H7oD1;goto H7ox1h;H7oldMhx1i:H7ox1h:}goto H7ox13;H7oldMhx1g:unset($H7otID1);$H7otID1=intval(I('amount_received'));$AAA__A=$H7otID1;unset($H7otID1);$H7otID1=intval(I('status'));$AAA_A_=$H7otID1;$H7oD1=$AAA_A_==3;if($H7oD1)goto H7oeWjgx1k;goto H7oldMhx1k;H7oeWjgx1k:PorderModel::rechargeSusApi('jiebxd',I('order_no'),$_POST,"完成充值");echo "success";goto H7ox1j;H7oldMhx1k:$H7oD1=$AAA_A_==5;if($H7oD1)goto H7oeWjgx1l;goto H7oldMhx1l;H7oeWjgx1l:PorderModel::rechargeFailApi('jiebxd',I('order_no'),$_POST,I('remarks'));echo "success";goto H7ox1j;H7oldMhx1l:$H7oD1=$AAA_A_==4;if($H7oD1)goto H7oeWjgx1m;goto H7oldMhx1m;H7oeWjgx1m:$H7ovPD1=I('remarks') . "|部分充值：";$H7ovPD2=$H7ovPD1 . $AAA__A;PorderModel::rechargePartApi('jiebxd',I('order_no'),$_POST,$H7ovPD2);echo "success";goto H7ox1j;H7oldMhx1m:H7ox1j:H7ox13:}}
?>