<?php
/*
 本代码由 成都大猿人网络科技有限公司 原创开发
 官方网址：www.dayuanren.cn
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace Recharge;use app\common\model\Porder as PorderModel;use think\Log;class Yuanren{private $userid;private $apikey;private $notify;private $apiurl;public function __construct($option){if(isset($option['param1']))goto MhbeWjgx2;goto MhbldMhx2;MhbeWjgx2:$MhbME=$option['param1'];goto Mhbx1;MhbldMhx2:$MhbME='';Mhbx1:unset($MhbtIMF);$MhbtIMF=$MhbME;$this->userid=$MhbtIMF;if(isset($option['param2']))goto MhbeWjgx4;goto MhbldMhx4;MhbeWjgx4:$MhbME=$option['param2'];goto Mhbx3;MhbldMhx4:$MhbME='';Mhbx3:unset($MhbtIMF);$MhbtIMF=$MhbME;$this->apikey=$MhbtIMF;if(isset($option['notify']))goto MhbeWjgx8;goto MhbldMhx8;MhbeWjgx8:$MhbME=$option['notify'];goto Mhbx7;MhbldMhx8:if(isset($option['param3']))goto MhbeWjgx6;goto MhbldMhx6;MhbeWjgx6:$MhbMF=$option['param3'];goto Mhbx5;MhbldMhx6:$MhbMF='';Mhbx5:$MhbME=$MhbMF;Mhbx7:unset($MhbtIMG);$MhbtIMG=$MhbME;$this->notify=$MhbtIMG;if(isset($option['param4']))goto MhbeWjgxa;goto MhbldMhxa;MhbeWjgxa:$MhbME=$option['param4'];goto Mhbx9;MhbldMhxa:$MhbME='';Mhbx9:unset($MhbtIMF);$MhbtIMF=$MhbME;$this->apiurl=$MhbtIMF;}public function recharge($out_trade_num,$mobile,$param,$isp=''){unset($MhbtIME);$MhbtIME=str_replace('省','',str_replace('市','',$isp));$area=$MhbtIME;$MhbME=(bool)strpos($param['oparam3'],"自治州");$MhbMF=!$MhbME;if($MhbMF)goto MhbeWjgxd;goto MhbldMhxd;MhbeWjgxd:$MhbME=strpos($param['oparam3'],"自治州")||strpos($param['oparam3'],"地区");goto Mhbxc;MhbldMhxd:Mhbxc:if($MhbME)goto MhbeWjgxe;goto MhbldMhxe;MhbeWjgxe:unset($MhbtIME);$MhbtIME=$param['oparam3'];$city=$MhbtIME;goto Mhbxb;MhbldMhxe:if(isset($param['oparam3']))goto MhbeWjgxg;goto MhbldMhxg;MhbeWjgxg:$MhbME=str_replace('市','',$param['oparam3']) . '市';$MhbMF=$MhbME;goto Mhbxf;MhbldMhxg:$MhbMF='';Mhbxf:unset($MhbtIMG);$MhbtIMG=$MhbMF;$city=$MhbtIMG;Mhbxb:if(isset($param['oparam1']))goto MhbeWjgxi;goto MhbldMhxi;MhbeWjgxi:$MhbvPME=$param['oparam1'];goto Mhbxh;MhbldMhxi:$MhbvPME='';Mhbxh:if(isset($param['oparam2']))goto MhbeWjgxk;goto MhbldMhxk;MhbeWjgxk:$MhbvPMF=$param['oparam2'];goto Mhbxj;MhbldMhxk:$MhbvPMF='';Mhbxj:unset($MhbtIMG);$MhbtIMG=["userid"=>$this->userid,"mobile"=>$mobile,"out_trade_num"=>$out_trade_num,"product_id"=>$param['param1'],"amount"=>$param['param2'],"price"=>$param['param3'],"notify_url"=>$this->notify,"area"=>$area,"id_card_no"=>$MhbvPME,"city"=>$city,"ytype"=>$MhbvPMF,"param1"=>$param['oparam1'],"param2"=>$param['oparam2'],"param3"=>$param['oparam3'],];$data=$MhbtIMG;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/recharge';return $this->http_get($MhbvPME,$data);}public function user(){unset($MhbtIME);$MhbtIME=["userid"=>$this->userid];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/user';return $this->http_get($MhbvPME,$data);}public function check($out_trade_nums){unset($MhbtIME);$MhbtIME=["userid"=>$this->userid,"out_trade_nums"=>$out_trade_nums];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/check';return $this->http_get($MhbvPME,$data);}public function remove($out_trade_nums){unset($MhbtIME);$MhbtIME=["userid"=>$this->userid,"out_trade_nums"=>$out_trade_nums];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/remove';return $this->http_get($MhbvPME,$data);}public function selfcheck($param){unset($MhbtIME);$MhbtIME=M('reapi')->where(['id'=>$param['api_cur_id']])->find();$option=$MhbtIME;$MhbME=new Yuanren($option);unset($MhbtIMF);$MhbtIMF=$MhbME;$hangmin=$MhbtIMF;unset($MhbtIME);$MhbtIME=$hangmin->check($param['api_order_number']);$res=$MhbtIME;$MhbME=$res['errno']==0;if($MhbME)goto MhbeWjgxm;goto MhbldMhxm;MhbeWjgxm:unset($MhbtIME);$MhbtIME=json_encode($res['data'][0],320);$ress=$MhbtIME;unset($MhbtIME);$MhbtIME=json_decode($ress,320);$res=$MhbtIME;M('porder')->where(['id'=>$param['id']])->setField(['pegging_time'=>time()]);if(isset($res['status']))goto MhbeWjgxo;goto MhbldMhxo;MhbeWjgxo:$MhbMF=(bool)in_array($res['status'],[3,9]);if($MhbMF)goto MhbeWjgxr;goto MhbldMhxr;MhbeWjgxr:$MhbME=$res['remark']!='';$MhbMF=in_array($res['status'],[3,9])&&$MhbME;goto Mhbxq;MhbldMhxr:Mhbxq:if($MhbMF)goto MhbeWjgxs;goto MhbldMhxs;MhbeWjgxs:M('porder')->where(['id'=>$param['id'],'status'=>['in',[3]]])->setField(['remark'=>$res['remark']]);$MhbME=$param['mobile'] . '-';$MhbMF=$MhbME . $res['remark'];$MhbMG=$MhbMF . '<br/>';echo $MhbMG;goto Mhbxp;MhbldMhxs:Mhbxp:goto Mhbxn;MhbldMhxo:Mhbxn:goto Mhbxl;MhbldMhxm:Mhbxl:}public function selfprice($param){unset($MhbtIME);$MhbtIME=M('reapi')->where(['id'=>$param['reapi_id']])->find();$partner_id=$MhbtIME;$MhbME=!$partner_id;if($MhbME)goto MhbeWjgxu;goto MhbldMhxu;MhbeWjgxu:return ;goto Mhbxt;MhbldMhxu:Mhbxt:unset($MhbtIME);$MhbtIME=["id"=>$param['param1'],"userid"=>$this->userid,];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$partner_id['param4'] . 'index/price';unset($MhbtIMF);$MhbtIMF=$this->http_get($MhbvPME,$data);$prices=$MhbtIMF;print_r($prices);if(isset($prices['data'][0]['price']))goto MhbeWjgxw;goto MhbldMhxw;MhbeWjgxw:$MhbME=floatval($prices['data'][0]['price'])>0;$MhbMG=(bool)$MhbME;if($MhbMG)goto MhbeWjgxz;goto MhbldMhxz;MhbeWjgxz:$MhbMF=floatval($prices['data'][0]['price'])!=floatval($param['price']);$MhbMG=$MhbME&&$MhbMF;goto Mhbxy;MhbldMhxz:Mhbxy:if($MhbMG)goto MhbeWjgx11;goto MhbldMhx11;MhbeWjgx11:M('product')->where(['id'=>$param['id']])->setField(['price'=>$prices['data'][0]['price']]);$MhbME="发现产品[" . $prices['data'][0]['name'];$MhbMF=$MhbME . "]价格变化，已同步价格，产品ID:";$MhbMG=$MhbMF . $param['id'];$MhbMH=$MhbMG . '-最新价格：';$MhbMI=$MhbMH . $prices['data'][0]['price'];$MhbMJ=$MhbMI . '<br>';echo $MhbMJ;goto Mhbxx;MhbldMhx11:Mhbxx:goto Mhbxv;MhbldMhxw:$MhbvPME=$partner_id['param4'] . 'index/product';unset($MhbtIMF);$MhbtIMF=$this->http_get($MhbvPME,$data);$result=$MhbtIMF;unset($MhbtIME);$MhbtIME=$result['data'];$porders=$MhbtIME;foreach($porders as $k=>$order){unset($MhbtIME);$MhbtIME=$order['products'];$products=$MhbtIME;foreach($products as $s=>$orders){$MhbME=$orders['id']==$param['param1'];if($MhbME)goto MhbeWjgx13;goto MhbldMhx13;MhbeWjgx13:$MhbMF=(bool)isset($orders['price']);if($MhbMF)goto MhbeWjgx18;goto MhbldMhx18;MhbeWjgx18:$MhbME=floatval($orders['price'])>0;$MhbMF=isset($orders['price'])&&$MhbME;goto Mhbx17;MhbldMhx18:Mhbx17:$MhbMH=(bool)$MhbMF;if($MhbMH)goto MhbeWjgx16;goto MhbldMhx16;MhbeWjgx16:$MhbMG=floatval($orders['price'])!=$param['price'];$MhbMH=$MhbMF&&$MhbMG;goto Mhbx15;MhbldMhx16:Mhbx15:if($MhbMH)goto MhbeWjgx19;goto MhbldMhx19;MhbeWjgx19:M('product')->where(['id'=>$param['id']])->setField(['price'=>$orders['price']]);$MhbME="发现产品[" . $orders['name'];$MhbMF=$MhbME . "]价格变化，已同步价格，产品ID:";$MhbMG=$MhbMF . $param['id'];$MhbMH=$MhbMG . '-最新价格：';$MhbMI=$MhbMH . $orders['price'];$MhbMJ=$MhbMI . '<br/>';echo $MhbMJ;goto Mhbx14;MhbldMhx19:Mhbx14:goto Mhbx12;MhbldMhx13:Mhbx12:}}Mhbxv:}public function selfup($param){unset($MhbtIME);$MhbtIME=M('reapi')->where(['id'=>$param['reapi_id']])->find();$partner_id=$MhbtIME;$MhbME=!$partner_id;if($MhbME)goto MhbeWjgx1b;goto MhbldMhx1b;MhbeWjgx1b:return ;goto Mhbx1a;MhbldMhx1b:Mhbx1a:unset($MhbtIME);$MhbtIME=["id"=>$param['param1'],"userid"=>$this->userid,];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$partner_id['param4'] . 'index/price';unset($MhbtIMF);$MhbtIMF=$this->http_get($MhbvPME,$data);$prices=$MhbtIMF;$MhbMF=(bool)isset($prices['data'][0]['added']);if($MhbMF)goto MhbeWjgx1e;goto MhbldMhx1e;MhbeWjgx1e:$MhbME=intval($prices['data'][0]['added'])!=intval($param['added']);$MhbMF=isset($prices['data'][0]['added'])&&$MhbME;goto Mhbx1d;MhbldMhx1e:Mhbx1d:if($MhbMF)goto MhbeWjgx1f;goto MhbldMhx1f;MhbeWjgx1f:unset($MhbtIME);$MhbtIME=intval($prices['data'][0]['added']);$up=$MhbtIME;M('product')->where(['id'=>$param['id']])->setField(['added'=>$up]);$MhbME=$up==1;if($MhbME)goto MhbeWjgx1h;goto MhbldMhx1h;MhbeWjgx1h:$MhbME="发现产品[" . $prices['data'][0]['name'];$MhbMF=$MhbME . "]状态变化，已同步上架，产品ID:";$MhbMG=$MhbMF . $param['id'];$MhbMH=$MhbMG . '<br/>';echo $MhbMH;goto Mhbx1g;MhbldMhx1h:$MhbME=$up==0;if($MhbME)goto MhbeWjgx1i;goto MhbldMhx1i;MhbeWjgx1i:$MhbME="发现产品[" . $prices['data'][0]['name'];$MhbMF=$MhbME . "]状态变化，已同步下架，产品ID:";$MhbMG=$MhbMF . $param['id'];$MhbMH=$MhbMG . '<br/>';echo $MhbMH;goto Mhbx1g;MhbldMhx1i:Mhbx1g:goto Mhbx1c;MhbldMhx1f:$MhbME='未正确获取到产品信息，请检查！' . '<br/>';echo $MhbME;Mhbx1c:}public function balance(){unset($MhbtIME);$MhbtIME=["userid"=>$this->userid];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/user';unset($MhbtIMF);$MhbtIMF=$this->http_get($MhbvPME,$data);$res=$MhbtIMF;$MhbME=$res['errno']!=0;if($MhbME)goto MhbeWjgx1k;goto MhbldMhx1k;MhbeWjgx1k:return '';goto Mhbx1j;MhbldMhx1k:if(isset($res['data']['balance']))goto MhbeWjgx1m;goto MhbldMhx1m;MhbeWjgx1m:$MhbME=$res['data']['balance'];goto Mhbx1l;MhbldMhx1m:$MhbME='';Mhbx1l:return $MhbME;Mhbx1j:}public function product(){unset($MhbtIME);$MhbtIME=["userid"=>$this->userid];$data=$MhbtIME;unset($MhbtIME);$MhbtIME=$this->sign($data);$data['sign']=$MhbtIME;$MhbvPME=$this->apiurl . 'index/product';return $this->http_get($MhbvPME,$data);}public function sign($data){ksort($data);$MhbME=http_build_query($data) . '&apikey=';$MhbMF=$MhbME . $this->apikey;unset($MhbtIMG);$MhbtIMG=$MhbMF;$sign_str=$MhbtIMG;unset($MhbtIME);$MhbtIME=urldecode($sign_str);$sign_str=$MhbtIME;return strtoupper(md5($sign_str));}public function notify(){if(I('selfcheck'))goto MhbeWjgx1o;goto MhbldMhx1o;MhbeWjgx1o:unset($MhbtIME);$MhbtIME=M('porder p')->join('reapi r','r.id=p.api_cur_id')->where(['r.callapi'=>'Yuanren','p.status'=>3,'type'=>3])->order('p.pegging_time asc ,p.create_time asc')->limit(10)->field('p.id,p.mobile,p.api_order_number,p.api_trade_num,p.api_cur_param_id,p.api_cur_id')->select();$porders=$MhbtIME;foreach($porders as $k=>$order){unset($MhbtIME);$MhbtIME=M('reapi')->where(['id'=>$order['api_cur_id']])->find();$option=$MhbtIME;$MhbME=new Yuanren($option);unset($MhbtIMF);$MhbtIMF=$MhbME;$hangmin=$MhbtIMF;unset($MhbtIME);$MhbtIME=$hangmin->check($order['api_order_number']);$res=$MhbtIME;print_r($res);$MhbME=$res['errno']==0;if($MhbME)goto MhbeWjgx1q;goto MhbldMhx1q;MhbeWjgx1q:unset($MhbtIME);$MhbtIME=json_encode($res['data'][0],320);$ress=$MhbtIME;unset($MhbtIME);$MhbtIME=json_decode($ress,320);$res=$MhbtIME;M('porder')->where(['id'=>$order['id']])->setField(['pegging_time'=>time()]);if(isset($res['status']))goto MhbeWjgx1s;goto MhbldMhx1s;MhbeWjgx1s:if(in_array($res['status'],[3,9]))goto MhbeWjgx1u;goto MhbldMhx1u;MhbeWjgx1u:M('porder')->where(['id'=>$order['id'],'status'=>['in',[3]]])->setField(['remark'=>$res['remark']]);$MhbME=$order['mobile'] . '-';$MhbMF=$MhbME . $res['remark'];$MhbMG=$MhbMF . '<br/>';echo $MhbMG;goto Mhbx1t;MhbldMhx1u:Mhbx1t:goto Mhbx1r;MhbldMhx1s:Mhbx1r:goto Mhbx1p;MhbldMhx1q:Mhbx1p:}goto Mhbx1n;MhbldMhx1o:unset($MhbtIME);$MhbtIME=$_POST;$data=$MhbtIME;unset($MhbtIME);$MhbtIME=M('reapi')->where(['param1'=>I('userid'),'callapi'=>'Yuanren','is_del'=>0])->find();$config=$MhbtIME;$MhbME=!$config;if($MhbME)goto MhbeWjgx1w;goto MhbldMhx1w;MhbeWjgx1w:echo "未找到配置信息";goto Mhbx1v;MhbldMhx1w:Mhbx1v:unset($MhbtIME);$MhbtIME=$config['param2'];$this->apikey=$MhbtIME;unset($data['sign']);$MhbME=$this->sign($data)!=I('sign');if($MhbME)goto MhbeWjgx1y;goto MhbldMhx1y;MhbeWjgx1y:echo "验签失败";goto Mhbx1x;MhbldMhx1y:Mhbx1x:unset($MhbtIME);$MhbtIME=intval(I('state'));$state=$MhbtIME;$MhbME=$state==1;if($MhbME)goto MhbeWjgx21;goto MhbldMhx21;MhbeWjgx21:PorderModel::rechargeSusApi('yuanren',I('out_trade_num'),$_POST,I('remark'),I('charge_kami'));echo "success";goto Mhbx2z;MhbldMhx21:if(in_array($state,[-1,2]))goto MhbeWjgx22;goto MhbldMhx22;MhbeWjgx22:PorderModel::rechargeFailApi('yuanren',I('out_trade_num'),$_POST,I('remark'));echo "success";goto Mhbx2z;MhbldMhx22:$MhbME=$state==3;if($MhbME)goto MhbeWjgx23;goto MhbldMhx23;MhbeWjgx23:$MhbvPME='部分充值:' . I('charge_amount');PorderModel::rechargePartApi('yuanren',I('out_trade_num'),$_POST,$MhbvPME,I('charge_amount'));echo "success";goto Mhbx2z;MhbldMhx23:$MhbME=$state==0;if($MhbME)goto MhbeWjgx24;goto MhbldMhx24;MhbeWjgx24:PorderModel::rechargeRateApi('yuanren',I('out_trade_num'),$_POST,I('charge_amount'));echo "success";goto Mhbx2z;MhbldMhx24:echo "未知的回调状态";Mhbx2z:Mhbx1n:}private function http_get($url,$param){unset($MhbtIME);$MhbtIME=curl_init();$oCurl=$MhbtIME;if(is_string($param))goto MhbeWjgx26;goto MhbldMhx26;MhbeWjgx26:unset($MhbtIME);$MhbtIME=$param;$strPOST=$MhbtIME;goto Mhbx25;MhbldMhx26:unset($MhbtIME);$MhbtIME=http_build_query($param);$strPOST=$MhbtIME;Mhbx25:curl_setopt($oCurl,CURLOPT_URL,$url);curl_setopt($oCurl,CURLOPT_RETURNTRANSFER,1);curl_setopt($oCurl,CURLOPT_POST,true);curl_setopt($oCurl,CURLOPT_POSTFIELDS,$strPOST);curl_setopt($oCurl,CURLOPT_CONNECTTIMEOUT,30);curl_setopt($oCurl,CURLOPT_TIMEOUT,90);curl_setopt($oCurl,CURLOPT_HEADER,0);curl_setopt($oCurl,CURLOPT_HTTPHEADER,["ContentType:application/x-www-form-urlencoded;charset=utf-8"]);unset($MhbtIME);$MhbtIME=curl_exec($oCurl);$sContent=$MhbtIME;unset($MhbtIME);$MhbtIME=curl_getinfo($oCurl);$aStatus=$MhbtIME;curl_close($oCurl);$MhbME=intval($aStatus["http_code"])==200;if($MhbME)goto MhbeWjgx28;goto MhbldMhx28;MhbeWjgx28:unset($MhbtIME);$MhbtIME=json_decode($sContent,true);$result=$MhbtIME;$MhbME=$result['errno']==0;if($MhbME)goto MhbeWjgx2a;goto MhbldMhx2a;MhbeWjgx2a:return rjson(0,$result['errmsg'],$result['data']);goto Mhbx29;MhbldMhx2a:if(isset($param['out_trade_num']))goto MhbeWjgx2c;goto MhbldMhx2c;MhbeWjgx2c:M('porder')->where(['api_order_number'=>$param['out_trade_num']])->setField(['remark'=>$result['errmsg']]);goto Mhbx2b;MhbldMhx2c:Mhbx2b:return rjson(1,$result['errmsg'],$result['data']);Mhbx29:goto Mhbx27;MhbldMhx28:$MhbvPME='接口访问失败，http错误码' . $aStatus["http_code"];return rjson(500,$MhbvPME);Mhbx27:}}
?>